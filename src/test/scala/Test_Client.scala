

import scala.concurrent.duration._
import akka.actor.{ActorSystem, Address, CoordinatedShutdown, Props}
import akka.pattern.ask
import akka.util.Timeout
import fr.acinq.bitcoin.Crypto.{PrivateKey, PublicKey}
import fr.acinq.bitcoin.{Base58, Btc, OP_0, Satoshi, Script, ScriptElt, Transaction}
import org.scalatest.BeforeAndAfterAll
import org.scalatest.funsuite.AnyFunSuite
import scodec.bits.ByteVector
import xyz.bitml.api.messaging.{AskForSigs, AssembledTx, CurrentState, DumpState, Init, Internal, Listen, Ping, Pong, PreInit, StopListening, TryAssemble}
import xyz.bitml.api.{ChunkEntry, ChunkPrivacy, ChunkType, Client, IndexEntry, Participant, Signer, TxEntry}
import xyz.bitml.api.persistence.{MetaStorage, ParticipantStorage, State, TxStorage}
import xyz.bitml.api.serialization.Serializer

import scala.concurrent.{Await, Future}

class Test_Client extends AnyFunSuite with BeforeAndAfterAll{

  private var testSystem : ActorSystem = _

  override def beforeAll(): Unit = {
    testSystem = ActorSystem(name = "internalTestSystem")
    super.beforeAll()
  }

  override def afterAll(): Unit = {
    CoordinatedShutdown(testSystem).run(CoordinatedShutdown.unknownReason)
    Thread.sleep(500)
    super.afterAll()
  }


  test("BitML compiler example"){
    /*
    #lang bitml

(participant "A" "03ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c3")
(participant "B" "03859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e")

(debug-mode)

(define (txA) "tx:02000000000101000225925157edb93dda00c3765d5f6aee486b67737662cf46cb436471c645f918000000171600145093f95239942f953d077e72c495583ed601cc95feffffff0240420f00000000001976a914ded135b86a7ff97aece531c8b97dc8a3cb3ddc7488ac75d513000000000017a91451329a63924dcc4876c6e94c6ad4957cedd115b88702463043022040fc9549ec6b98027dd7f73373317b05dabb2c528f081a00b4e25ed34ca6e91f021f319d47780bb90a61b4e5257f47ccbb52eee736f4897d5b4d5a19b3df5f3ed8012102df8bd0680cb7ecf1f70eef399f9359a025b96fb776055a2150cbc973def82c116d191700@0")
(define (txFee) "tx:02000000000101adbcf28818d2556fb85ce7f6068775a6a4fd4befe650d3d7d120b609e5af1e920100000017160014a5d12120913a41cdd3be9ef88b60838b8c0db3b7feffffff028ac710000000000017a914664180e7578033f9cef5bc82b3112855f775f02587a0860100000000001976a914ded135b86a7ff97aece531c8b97dc8a3cb3ddc7488ac024730440220290f9526ed5e22d4ae72c66702f5f70dff4c5ea72445cd20112782da1986332e02201d872a0a53fa13b34a9273776dfcd0ea7385e449fec1e95263bdde96fda084e10121021215eb7fabd9bb0c1f1441bf35bade28d9e64dc798a666eb4eaf47e134a74b446d191700@1")

(contract
 (pre (deposit "A" 0.01 (ref (txA)))
      (fee "A" 0.001 (ref (txFee))))

 (withdraw "B"))

const pubkeyA2 = pubkey:03ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c3
const pubkeyB1 = pubkey:03859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e

const pubkeyB = pubkey:03859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e
const pubkeyA = pubkey:03ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c3

const sigA0 : signature = _ //add signature for output tx:02000000000101000225925157edb93dda00c3765d5f6aee486b67737662cf46cb436471c645f918000000171600145093f95239942f953d077e72c495583ed601cc95feffffff0240420f00000000001976a914ded135b86a7ff97aece531c8b97dc8a3cb3ddc7488ac75d513000000000017a91451329a63924dcc4876c6e94c6ad4957cedd115b88702463043022040fc9549ec6b98027dd7f73373317b05dabb2c528f081a00b4e25ed34ca6e91f021f319d47780bb90a61b4e5257f47ccbb52eee736f4897d5b4d5a19b3df5f3ed8012102df8bd0680cb7ecf1f70eef399f9359a025b96fb776055a2150cbc973def82c116d191700@0
const sigAFee : signature = _ //add signature for output tx:02000000000101adbcf28818d2556fb85ce7f6068775a6a4fd4befe650d3d7d120b609e5af1e920100000017160014a5d12120913a41cdd3be9ef88b60838b8c0db3b7feffffff028ac710000000000017a914664180e7578033f9cef5bc82b3112855f775f02587a0860100000000001976a914ded135b86a7ff97aece531c8b97dc8a3cb3ddc7488ac024730440220290f9526ed5e22d4ae72c66702f5f70dff4c5ea72445cd20112782da1986332e02201d872a0a53fa13b34a9273776dfcd0ea7385e449fec1e95263bdde96fda084e10121021215eb7fabd9bb0c1f1441bf35bade28d9e64dc798a666eb4eaf47e134a74b446d191700@1

const privkeyA = key:cUnBMKCcvtpuVcfWajJBEF9uQaeNJmcRM6Vasw1vj3ZkiaoAGEuH

transaction Tinit {
 input = [ tx:02000000000101000225925157edb93dda00c3765d5f6aee486b67737662cf46cb436471c645f918000000171600145093f95239942f953d077e72c495583ed601cc95feffffff0240420f00000000001976a914ded135b86a7ff97aece531c8b97dc8a3cb3ddc7488ac75d513000000000017a91451329a63924dcc4876c6e94c6ad4957cedd115b88702463043022040fc9549ec6b98027dd7f73373317b05dabb2c528f081a00b4e25ed34ca6e91f021f319d47780bb90a61b4e5257f47ccbb52eee736f4897d5b4d5a19b3df5f3ed8012102df8bd0680cb7ecf1f70eef399f9359a025b96fb776055a2150cbc973def82c116d191700@0:sigA0; tx:02000000000101adbcf28818d2556fb85ce7f6068775a6a4fd4befe650d3d7d120b609e5af1e920100000017160014a5d12120913a41cdd3be9ef88b60838b8c0db3b7feffffff028ac710000000000017a914664180e7578033f9cef5bc82b3112855f775f02587a0860100000000001976a914ded135b86a7ff97aece531c8b97dc8a3cb3ddc7488ac024730440220290f9526ed5e22d4ae72c66702f5f70dff4c5ea72445cd20112782da1986332e02201d872a0a53fa13b34a9273776dfcd0ea7385e449fec1e95263bdde96fda084e10121021215eb7fabd9bb0c1f1441bf35bade28d9e64dc798a666eb4eaf47e134a74b446d191700@1:sigAFee ]
 output = 0.01070001 BTC : fun(sB, sA) .
 (( versig(pubkeyB1, pubkeyA2; sB, sA) ))
}

const sigBT1 : signature = _
const sigAT1 : signature = _

transaction T1 {
 input = [ Tinit@0:  sigBT1 sigAT1 ]
 output = 0.0104 BTC : fun(x) . versig(pubkeyB; x)

}

eval Tinit, T1


PARTICIPANTS (with our test endpoints)
(participant name:"A" pubkey:"03ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c3" endpoint:"localhost:25000")
(participant name:"B" pubkey:"03859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e" endpoint:"localhost:25000")

RAW TXS:
Tinit (with sigA0, sigFee blank) : "02000000027be5fa01cf6465d71c0335c5f34c53a1d2a7b29d567d442e1e98f0e64e15a06a0000000023002102a6d35321c8930c1da17df79edebaf13192ee3e39c9abcea6d8dd9c5f3640e2abffffffff9d26302a3e82b2475a6ba09a0e0e0c6cf4626125ff012232180a41415be1e5a00100000023002102a6d35321c8930c1da17df79edebaf13192ee3e39c9abcea6d8dd9c5f3640e2abffffffff01b15310000000000017a9147a06737efe61a6d916abdc59b7c099ae570c39ca8700000000"
T1 (with sigBT1, sigAT1 blank) : "020000000164206af5b72934c9b198dce52f65e2a1e3d87110ebe458ddd87e048c0d7b60d4000000005500004c516b6b006c766c766b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352aeffffffff0180de0f00000000001976a914ce07ee1448bbb80b38ae0c03b6cdeff40ff326ba88ac00000000"

META:
Tinit:[0:[0:(P2PKH on from A)], 1:[(p2pkh from A)]]
T1:[0:[0:(P2PKH from B, P2PKH from A)]]

     */

    // Generate initial state JSON with our own internal serialization
    val tinit = Transaction.read("02000000027be5fa01cf6465d71c0335c5f34c53a1d2a7b29d567d442e1e98f0e64e15a06a0000000023002102a6d35321c8930c1da17df79edebaf13192ee3e39c9abcea6d8dd9c5f3640e2abffffffff9d26302a3e82b2475a6ba09a0e0e0c6cf4626125ff012232180a41415be1e5a00100000023002102a6d35321c8930c1da17df79edebaf13192ee3e39c9abcea6d8dd9c5f3640e2abffffffff01b15310000000000017a9147a06737efe61a6d916abdc59b7c099ae570c39ca8700000000")
    val t1 = Transaction.read("020000000164206af5b72934c9b198dce52f65e2a1e3d87110ebe458ddd87e048c0d7b60d4000000005500004c516b6b006c766c766b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352aeffffffff0180de0f00000000001976a914ce07ee1448bbb80b38ae0c03b6cdeff40ff326ba88ac00000000")
    val txdb = new TxStorage()
    txdb.save("Tinit", tinit)
    txdb.save("T1", t1)

    val a_pub = PublicKey(ByteVector.fromValidHex("03ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c3"))
    val a_p = Participant("A", List(a_pub), Address("akka", "test", "127.0.0.1", 25000))
    val b_pub = PublicKey(ByteVector.fromValidHex("03859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e"))
    val b_p = Participant("B", List(b_pub), Address("akka", "test", "127.0.0.1", 25001))
    val partdb = new ParticipantStorage()
    partdb.save(a_p)
    partdb.save(b_p)

    val tinit0_chunks = Seq(
      ChunkEntry(chunkType = ChunkType.SIG_P2PKH, chunkPrivacy= ChunkPrivacy.AUTH, chunkIndex = 0, owner = Option(a_pub), data = ByteVector.empty))
    val tinit1_chunks = Seq(
      ChunkEntry(chunkType = ChunkType.SIG_P2PKH, chunkPrivacy= ChunkPrivacy.AUTH, chunkIndex = 0, owner = Option(a_pub), data = ByteVector.empty))
    val t1_chunks = Seq(
      ChunkEntry(chunkType = ChunkType.SIG_P2SH, chunkPrivacy= ChunkPrivacy.PUBLIC, chunkIndex = 0, owner = Option(b_pub), data = ByteVector.empty),
      ChunkEntry(chunkType = ChunkType.SIG_P2SH, chunkPrivacy= ChunkPrivacy.PUBLIC, chunkIndex = 1, owner = Option(a_pub), data = ByteVector.empty))
    val tinit_entry = TxEntry(name = "Tinit", indexData = Map(
      0 -> IndexEntry(amt = Satoshi(1000000) ,chunkData = tinit0_chunks),
      1 -> IndexEntry(amt = Satoshi(100000) ,chunkData = tinit1_chunks)))
    val t1_entry = TxEntry(name = "T1", indexData = Map(0 -> IndexEntry(amt = Satoshi(1070001) ,chunkData = t1_chunks)))

    val metadb = new MetaStorage()
    metadb.save(tinit_entry)
    metadb.save(t1_entry)

    val initialState = State(partdb, txdb, metadb)
    val stateJson = new Serializer().prettyPrintState(initialState)
    //println(stateJson)

    // The compiler example doesn't actually follow the normal contract flow, but just produces the first Tinit from A's private key.

    val a_priv = PrivateKey.fromBase58("cSthBXr8YQAexpKeh22LB9PdextVE1UJeahmyns5LzcmMDSy59L4", Base58.Prefix.SecretKeyTestnet)._1
    assert(a_priv.publicKey == a_pub)

    // Start an actor
    val alice = testSystem.actorOf(Props[Client])

    // Initialize Alice with the state information.
    alice ! Init(a_priv, stateJson)
    // Start the network interface (even though in this test we won't communicate with B)
    alice ! Listen("test_application.conf", a_p.endpoint.system)

    // AFter letting A initialize, see if it can assemble Tinit on its own
    Thread.sleep(2000)
    implicit val timeout : Timeout = 1 second
    val future3 = alice ? TryAssemble("Tinit")
    val res3 = Await.result(future3, timeout.duration).asInstanceOf[AssembledTx].serializedTx
    // The node has produced a transaction.
    assert(res3.length != 0)
    println(Transaction.read(res3).txIn)


    alice ! StopListening()
  }

  test("Two Player Lottery"){
    /*
    #lang bitml

(debug-mode)

(define (txA) "tx:02000000000101124327402f588c4b46cfa8b1670495bd9f6f57b969212af5b8afe5da191e349f0000000017160014ca98e2fc277b25dfe48db007419b4b6f7eff7cb2feffffff0205f717000000000017a914ffe4b939f7384b08ec04b2f605b0dca4413af16a87e0930400000000001976a914ded135b86a7ff97aece531c8b97dc8a3cb3ddc7488ac024730440220197c12bf078c2bbc8f86ce93cb42042e3d528ee62de5647c1827229fe9b809ef02205e6faf5a1af59aefe493055e2cdc9d435e3524bba1cc9179e343aa8ae311de30012102a0a9937b3273031c28c1c1c4f87d7d89e4d6f973bdb00e6447a708d2c91991b2cd271700@1")
(define (txB) "tx:02000000000101bb536c381e14e1edf2d460d2e0a9ed649da2b61733d0a5d101489c5ba7fba8400100000017160014023b9558d3736f47b3ff16dcb66800ae89fc681dfeffffff025c8c3e000000000017a9140cd0faeac9fd6f23f57e206d170cd9df909e9ac987e0930400000000001976a914ce07ee1448bbb80b38ae0c03b6cdeff40ff326ba88ac02473044022059ed91550240d9da58e3cef4dabc2b2719ce36c5e05a7af35c6c321fd914c5e70220149e461c53c155706ad6b27bf1f6b08f40a2ad3a2f4c23d41481df840caafce7012102407baf142709a99a67a19c6e9ea8af329e5b1cd6ba1d178f0a5fce3a94db8eb9e1271700@1")
(define (txFee) "tx:02000000000101cc1a7d72cd7c5f64d2e0f34a0f929532b11e18a0802a2cd9d2503fd60b19585e00000000171600149e7b7e6acb6c7d0b613bb3c72f55afc723686683feffffff0240420f00000000001976a914ce07ee1448bbb80b38ae0c03b6cdeff40ff326ba88acfedd33000000000017a914677fd79b9ab537dea966e328afa6fb27d8e9aa3b870247304402201bf5adf5fdea7f1939798fb5acd8a5e75aecddee47a0d101f1113ba5f4a28a3e02205461cd71f3e757d92a0d0635937a13e219508c1be7464473b717e92cf622d642012103fa6e338afbb1bd9ffe0abc107dc15eb38811babac4d2a67fa6b78a2bd38a0809e1271700@0")

(participant "A" "03ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c3")
(participant "B" "03859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e")

(contract (pre
           (deposit "A" 0.003 (ref (txA)))(secret "A" a "b472a266d0bd89c13706a4132ccfb16f7c3b9fcb")
           (deposit "B" 0.003 (ref (txB)))(secret "B" b "c51b66bced5e4491001bd702669770dccf440982")
           (fee "B" 0.01 (ref (txFee))))

          (split
           (0.002 -> (choice
                  (revealif (b) (pred (between b 0 1)) (withdraw "B"))
                  (after 1500000 (withdraw "A"))))
           (0.002 -> (choice
                  (reveal (a) (withdraw "A"))
                  (after 1500000 (withdraw "B"))))
           (0.002 -> (choice
                  (revealif (a b) (pred (= a b)) (withdraw "A"))
                  (revealif (a b) (pred (!= a b)) (withdraw "B"))
                  (after 1500000 (split (0.001 -> (withdraw "A")) (0.001 -> (withdraw "B")))))))

          (auto-generate-secrets)
          (check-liquid))

Modified Balzac result:
  //const sec_a:string = "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
//const sec_b:string = "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001"
const sec_a:string = _
const sec_b:string = _


const pubkeyB3 = pubkey:03859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e
const pubkeyA18 = pubkey:03ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c3
const pubkeyA14 = pubkey:03ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c3
const pubkeyB1 = pubkey:03859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e
const pubkeyA2 = pubkey:03ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c3
const pubkeyB17 = pubkey:03859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e
const pubkeyA12 = pubkey:03ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c3
const pubkeyA10 = pubkey:03ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c3
const pubkeyB9 = pubkey:03859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e
const pubkeyA8 = pubkey:03ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c3
const pubkeyA6 = pubkey:03ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c3
const pubkeyB7 = pubkey:03859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e
const pubkeyB19 = pubkey:03859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e
const pubkeyA20 = pubkey:03ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c3
const pubkeyA4 = pubkey:03ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c3
const pubkeyA16 = pubkey:03ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c3
const pubkeyB5 = pubkey:03859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e
const pubkeyB13 = pubkey:03859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e
const pubkeyB15 = pubkey:03859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e
const pubkeyB11 = pubkey:03859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e

const pubkeyB = pubkey:03859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e
const pubkeyA = pubkey:03ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c3

const sigB : signature = _
const sigA : signature = _


transaction Tinit {
 input = [
 tx:02000000000101bb536c381e14e1edf2d460d2e0a9ed649da2b61733d0a5d101489c5ba7fba8400100000017160014023b9558d3736f47b3ff16dcb66800ae89fc681dfeffffff025c8c3e000000000017a9140cd0faeac9fd6f23f57e206d170cd9df909e9ac987e0930400000000001976a914ce07ee1448bbb80b38ae0c03b6cdeff40ff326ba88ac02473044022059ed91550240d9da58e3cef4dabc2b2719ce36c5e05a7af35c6c321fd914c5e70220149e461c53c155706ad6b27bf1f6b08f40a2ad3a2f4c23d41481df840caafce7012102407baf142709a99a67a19c6e9ea8af329e5b1cd6ba1d178f0a5fce3a94db8eb9e1271700@1:sigB;
 tx:02000000000101124327402f588c4b46cfa8b1670495bd9f6f57b969212af5b8afe5da191e349f0000000017160014ca98e2fc277b25dfe48db007419b4b6f7eff7cb2feffffff0205f717000000000017a914ffe4b939f7384b08ec04b2f605b0dca4413af16a87e0930400000000001976a914ded135b86a7ff97aece531c8b97dc8a3cb3ddc7488ac024730440220197c12bf078c2bbc8f86ce93cb42042e3d528ee62de5647c1827229fe9b809ef02205e6faf5a1af59aefe493055e2cdc9d435e3524bba1cc9179e343aa8ae311de30012102a0a9937b3273031c28c1c1c4f87d7d89e4d6f973bdb00e6447a708d2c91991b2cd271700@1:sigA;
 tx:02000000000101cc1a7d72cd7c5f64d2e0f34a0f929532b11e18a0802a2cd9d2503fd60b19585e00000000171600149e7b7e6acb6c7d0b613bb3c72f55afc723686683feffffff0240420f00000000001976a914ce07ee1448bbb80b38ae0c03b6cdeff40ff326ba88acfedd33000000000017a914677fd79b9ab537dea966e328afa6fb27d8e9aa3b870247304402201bf5adf5fdea7f1939798fb5acd8a5e75aecddee47a0d101f1113ba5f4a28a3e02205461cd71f3e757d92a0d0635937a13e219508c1be7464473b717e92cf622d642012103fa6e338afbb1bd9ffe0abc107dc15eb38811babac4d2a67fa6b78a2bd38a0809e1271700@0:sigB]
 output = 0.01569999 BTC : fun(sB, sA) . (( versig(pubkeyB1, pubkeyA2; sB, sA) ))
}

transaction T1 {
 input = [ Tinit@0: sigB sigA ]
 output = [ 0.00513333 BTC : fun(b:string, sB, sA) . (((between((size(b) - 128),0,2) && hash160(b) == hash:c51b66bced5e4491001bd702669770dccf440982 && size(b) >= 128 && versig(pubkeyB3, pubkeyA4; sB, sA)) ||
 versig(pubkeyB5, pubkeyA6; sB, sA)));
        0.00513333 BTC : fun(a:string, sB, sA) . (((hash160(a) == hash:b472a266d0bd89c13706a4132ccfb16f7c3b9fcb && size(a) >= 128 && versig(pubkeyB7, pubkeyA8; sB, sA)) ||
 versig(pubkeyB9, pubkeyA10; sB, sA)));
        0.00513333 BTC : fun(a:string, b:string, sB, sA) . (((size(a) == size(b) && hash160(a) == hash:b472a266d0bd89c13706a4132ccfb16f7c3b9fcb && size(a) >= 128 && hash160(b) == hash:c51b66bced5e4491001bd702669770dccf440982 && size(b) >= 128 && versig(pubkeyB11, pubkeyA12; sB, sA)) ||
 (size(a) != size(b) && hash160(a) == hash:b472a266d0bd89c13706a4132ccfb16f7c3b9fcb && size(a) >= 128 && hash160(b) == hash:c51b66bced5e4491001bd702669770dccf440982 && size(b) >= 128 && versig(pubkeyB13, pubkeyA14; sB, sA)) ||
 versig(pubkeyB15, pubkeyA16; sB, sA))) ]
}

transaction T2 {
 input = [ T1@0:sec_b  sigB sigA ]
 output = 0.00483333 BTC : fun(sB, sA) . versig(pubkeyB17, pubkeyA18; sB, sA)
}

const sigBT3 : signature = _
const sigAT3 : signature = _

transaction T3 {
 input = [ T2@0:   sigB sigA ]
 output = 0.00453333 BTC : fun(x) . versig(pubkeyB; x)

}

transaction T4 {
 input = [ T1@0: ""  sigB sigA ]
 output = 0.00483333 BTC : fun(x) . versig(pubkeyA; x)
 absLock = block 1500000
}

transaction T5 {
 input = [ T1@1:sec_a  sigB sigA ]
 output = 0.00483333 BTC : fun(sB, sA) . versig(pubkeyB19, pubkeyA20; sB, sA)
}

const sigBT6 : signature = _
const sigAT6 : signature = _

transaction T6 {
 input = [ T5@0:  sigB sigA ]
 output = 0.00453333 BTC : fun(x) . versig(pubkeyA; x)

}

transaction T7 {
 input = [ T1@1: "" sigB sigA ]
 output = 0.00483333 BTC : fun(x) . versig(pubkeyB; x)
 absLock = block 1500000
}

transaction T8 {
 input = [ T1@2:sec_a sec_b  sigB sigA ]
 output = 0.00483333 BTC : fun(sB, sA) . versig(pubkeyB19, pubkeyA20; sB, sA)
}

transaction T9 {
 input = [ T8@0:   sigB sigA ]
 output = 0.00453333 BTC : fun(x) . versig(pubkeyA; x)

}

transaction T10 {
 input = [ T1@2:sec_a sec_b  sigB sigA ]
 output = 0.00483333 BTC : fun(sB, sA) . versig(pubkeyB17, pubkeyA18; sB, sA)
}

transaction T11 {
 input = [ T10@0:  sigB sigA ]
 output = 0.00453333 BTC : fun(x) . versig(pubkeyB; x)

}

transaction T12 {
 input = [ T1@2: "" "" sigB sigA ]
 output = [ 0.00241666 BTC : fun(sB, sA) . ((versig(pubkeyB19, pubkeyA20; sB, sA)));
        0.00241666 BTC : fun(sB, sA) . ((versig(pubkeyB17, pubkeyA18; sB, sA))) ]
 absLock = block 1500000
}

transaction T13 {
 input = [ T12@0:  sigB sigA ]
 output = 0.00211666 BTC : fun(x) . versig(pubkeyA; x)

}

transaction T14 {
 input = [ T12@1:  sigB sigA]
 output = 0.00211666 BTC : fun(x) . versig(pubkeyB; x)

}

eval Tinit, T1, T2, T3, T4, T5, T6, T7, T8, T9, T10, T11, T12, T13, T14

Result:

135

eval Tinit, T1, T2, T3, T4, T5, T6, T7, T8, T9, T10, T11, T12, T13, T14

Tinit
Transaction{5e2ab99febce35ebc192237d1f4dc5b91108ccc69436a52f69e65b074e008e01
weight: 1080 wu, 270 bytes
version 2
purpose: UNKNOWN
   in   0[] PUSHDATA(33)[02a6d35321c8930c1da17df79edebaf13192ee3e39c9abcea6d8dd9c5f3640e2ab]
        P2PKH addr:mzJLzZFoBqq8vyU4A5qfp8RAR1zC1GaqZv  outpoint:f997f995d2cefc7622f6034cad4d92f2ed32df6c5e8167de4648b4a34899bd4e:1
   in   0[] PUSHDATA(33)[02a6d35321c8930c1da17df79edebaf13192ee3e39c9abcea6d8dd9c5f3640e2ab]
        P2PKH addr:n1q6vo5VabL1BpqVKyHjvh4vaHrAq5NcYR  outpoint:48a1783dc99aee2e8f903fb2af16ad1fdafc9f5fcd3889b50de0f38de54963e4:1
   in   0[] PUSHDATA(33)[02a6d35321c8930c1da17df79edebaf13192ee3e39c9abcea6d8dd9c5f3640e2ab]
        P2PKH addr:mzJLzZFoBqq8vyU4A5qfp8RAR1zC1GaqZv  outpoint:c3bc6d2651a611d202455f3f580731a1d8d3c401ba183909c8df44c152777ccf:0
   out  HASH160 PUSHDATA(20)[2e38f05e636989a28f71fe9be443f82e9ce3453e] EQUAL  0.01569999 BTC
        P2SH addr:2MwTdHJ4thrcqJLUuhKCnUoajqKCiuFsEyU
}
02000000034ebd9948a3b44846de67815e6cdf32edf2924dad4c03f62276fcced295f997f90100000023002102a6d35321c8930c1da17df79edebaf13192ee3e39c9abcea6d8dd9c5f3640e2abffffffffe46349e58df3e00db58938cd5f9ffcda1fad16afb23f908f2eee9ac93d78a1480100000023002102a6d35321c8930c1da17df79edebaf13192ee3e39c9abcea6d8dd9c5f3640e2abffffffffcf7c7752c144dfc8093918ba01c4d3d8a13107583f5f4502d211a651266dbcc30000000023002102a6d35321c8930c1da17df79edebaf13192ee3e39c9abcea6d8dd9c5f3640e2abffffffff01cff417000000000017a9142e38f05e636989a28f71fe9be443f82e9ce3453e8700000000


T1
Transaction{16a6d115090531f47888834552c5556ce658e7c0966d158e2583f815549adae8
weight: 928 wu, 232 bytes
version 2
purpose: UNKNOWN
   in   0[] 0[] PUSHDATA1[6b6b006c766c766b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352ae]
        P2SH addr:2MwTdHJ4thrcqJLUuhKCnUoajqKCiuFsEyU  outpoint:5e2ab99febce35ebc192237d1f4dc5b91108ccc69436a52f69e65b074e008e01:0
   out  HASH160 PUSHDATA(20)[5d47e7c94f98c7462298a1fd74438e2edc9bdc48] EQUAL  0.00513333 BTC
        P2SH addr:2N1kSyCZBVsZeNdZEU2pDnvea9d8BBGMeEa
   out  HASH160 PUSHDATA(20)[5c77a7884016e20b07be95bcfab9f63a5926e92e] EQUAL  0.00513333 BTC
        P2SH addr:2N1g9VffNHBHLUidrAD1UHUb4DkVtmy9W1p
   out  HASH160 PUSHDATA(20)[d5944b405abb7dc532047245952eca7bd9116a6e] EQUAL  0.00513333 BTC
        P2SH addr:2NCiXZnfdg6D3SuqY4KaTiVy2pGbSeqAxtu
}
0200000001018e004e075be6692fa53694c6cc0811b9c54d1f7d2392c1eb35ceeb9fb92a5e000000005500004c516b6b006c766c766b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352aeffffffff0335d507000000000017a9145d47e7c94f98c7462298a1fd74438e2edc9bdc488735d507000000000017a9145c77a7884016e20b07be95bcfab9f63a5926e92e8735d507000000000017a914d5944b405abb7dc532047245952eca7bd9116a6e8700000000


T2
Transaction{bd23e1f91e300abf47d22e6bed13abb61cf33659ffba189539a902141e2e6cfa
weight: 1296 wu, 324 bytes
version 2
purpose: UNKNOWN
   in   0[] 0[] 0[] PUSHDATA1[6b6b766b827c75028000940052a5636c766ba914c51b66bced5e4491001bd702669770dccf44098287670068636c766b827c75028000a267006863006c6c766b7c6c6c766b7c6b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352ae670068635167006c6c766b7c6c6c766b7c6b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352ae68]
        P2SH addr:2N1kSyCZBVsZeNdZEU2pDnvea9d8BBGMeEa  outpoint:16a6d115090531f47888834552c5556ce658e7c0966d158e2583f815549adae8:0
   out  HASH160 PUSHDATA(20)[2e38f05e636989a28f71fe9be443f82e9ce3453e] EQUAL  0.00483333 BTC
        P2SH addr:2MwTdHJ4thrcqJLUuhKCnUoajqKCiuFsEyU
}
0200000001e8da9a5415f883258e156d96c0e758e66c55c55245838878f431050915d1a61600000000f10000004cec6b6b766b827c75028000940052a5636c766ba914c51b66bced5e4491001bd702669770dccf44098287670068636c766b827c75028000a267006863006c6c766b7c6c6c766b7c6b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352ae670068635167006c6c766b7c6c6c766b7c6b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352ae68ffffffff01056007000000000017a9142e38f05e636989a28f71fe9be443f82e9ce3453e8700000000


T3
Transaction{8226206e752f4b289e64bc5ca1de386aca01ff29473d421c5452d2ea3288ecbc
weight: 680 wu, 170 bytes
version 2
purpose: UNKNOWN
   in   0[] 0[] PUSHDATA1[6b6b006c766c766b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352ae]
        P2SH addr:2MwTdHJ4thrcqJLUuhKCnUoajqKCiuFsEyU  outpoint:bd23e1f91e300abf47d22e6bed13abb61cf33659ffba189539a902141e2e6cfa:0
   out  DUP HASH160 PUSHDATA(20)[ba91ed34ad92a7c2aa2d764c73cd0f31a18df680] EQUALVERIFY CHECKSIG  0.00453333 BTC
        P2PKH addr:mxXSnteng7Jkg3sc7xps6Nnw8jxEgLEBky
}
0200000001fa6c2e1e1402a9399518baff5936f31cb6ab13ed6b2ed247bf0a301ef9e123bd000000005500004c516b6b006c766c766b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352aeffffffff01d5ea0600000000001976a914ba91ed34ad92a7c2aa2d764c73cd0f31a18df68088ac00000000


T4
Transaction{31ae731b4b862858016d335689114fd69d2a2e8a889f6df8d11e3745cc9e4139
weight: 1304 wu, 326 bytes
version 2
time locked until block 1500000
purpose: UNKNOWN
   in   0[] 0[] 0[] PUSHDATA1[6b6b766b827c75028000940052a5636c766ba914c51b66bced5e4491001bd702669770dccf44098287670068636c766b827c75028000a267006863006c6c766b7c6c6c766b7c6b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352ae670068635167006c6c766b7c6c6c766b7c6b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352ae68]
        P2SH addr:2N1kSyCZBVsZeNdZEU2pDnvea9d8BBGMeEa  outpoint:16a6d115090531f47888834552c5556ce658e7c0966d158e2583f815549adae8:0
        sequence:fffffffe
   out  DUP HASH160 PUSHDATA(20)[448f9bd84d520fb00adb83f26d8a78ddc5403c89] EQUALVERIFY CHECKSIG  0.00483333 BTC
        P2PKH addr:mmmUHDB4rQasyk5FszofhjfEW9vHuZM5Lz
}
0200000001e8da9a5415f883258e156d96c0e758e66c55c55245838878f431050915d1a61600000000f10000004cec6b6b766b827c75028000940052a5636c766ba914c51b66bced5e4491001bd702669770dccf44098287670068636c766b827c75028000a267006863006c6c766b7c6c6c766b7c6b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352ae670068635167006c6c766b7c6c6c766b7c6b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352ae68feffffff0105600700000000001976a914448f9bd84d520fb00adb83f26d8a78ddc5403c8988ac60e31600


T5
Transaction{76ca0c07086dc83ebc4582f78a50401296091a03f1779220ebcd19ab2a983ce0
weight: 1228 wu, 307 bytes
version 2
purpose: UNKNOWN
   in   0[] 0[] 0[] PUSHDATA1[6b6b766ba914b472a266d0bd89c13706a4132ccfb16f7c3b9fcb87636c766b827c75028000a267006863006c6c766b7c6c6c766b7c6b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352ae670068635167006c6c766b7c6c6c766b7c6b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352ae68]
        P2SH addr:2N1g9VffNHBHLUidrAD1UHUb4DkVtmy9W1p  outpoint:16a6d115090531f47888834552c5556ce658e7c0966d158e2583f815549adae8:1
   out  HASH160 PUSHDATA(20)[2e38f05e636989a28f71fe9be443f82e9ce3453e] EQUAL  0.00483333 BTC
        P2SH addr:2MwTdHJ4thrcqJLUuhKCnUoajqKCiuFsEyU
}
0200000001e8da9a5415f883258e156d96c0e758e66c55c55245838878f431050915d1a61601000000e00000004cdb6b6b766ba914b472a266d0bd89c13706a4132ccfb16f7c3b9fcb87636c766b827c75028000a267006863006c6c766b7c6c6c766b7c6b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352ae670068635167006c6c766b7c6c6c766b7c6b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352ae68ffffffff01056007000000000017a9142e38f05e636989a28f71fe9be443f82e9ce3453e8700000000


T6
Transaction{0dbfe85e83698cf7c46f59d42a102365f2dce7b3312191c37d21c0eecd3099d3
weight: 680 wu, 170 bytes
version 2
purpose: UNKNOWN
   in   0[] 0[] PUSHDATA1[6b6b006c766c766b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352ae]
        P2SH addr:2MwTdHJ4thrcqJLUuhKCnUoajqKCiuFsEyU  outpoint:76ca0c07086dc83ebc4582f78a50401296091a03f1779220ebcd19ab2a983ce0:0
   out  DUP HASH160 PUSHDATA(20)[448f9bd84d520fb00adb83f26d8a78ddc5403c89] EQUALVERIFY CHECKSIG  0.00453333 BTC
        P2PKH addr:mmmUHDB4rQasyk5FszofhjfEW9vHuZM5Lz
}
0200000001e03c982aab19cdeb209277f1031a09961240508af78245bc3ec86d08070cca76000000005500004c516b6b006c766c766b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352aeffffffff01d5ea0600000000001976a914448f9bd84d520fb00adb83f26d8a78ddc5403c8988ac00000000


T7
Transaction{63ac0c7bfd01892075f6ed499462684143b2da0c36afc65cdb0b87f14340ee9d
weight: 1236 wu, 309 bytes
version 2
time locked until block 1500000
purpose: UNKNOWN
   in   0[] 0[] 0[] PUSHDATA1[6b6b766ba914b472a266d0bd89c13706a4132ccfb16f7c3b9fcb87636c766b827c75028000a267006863006c6c766b7c6c6c766b7c6b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352ae670068635167006c6c766b7c6c6c766b7c6b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352ae68]
        P2SH addr:2N1g9VffNHBHLUidrAD1UHUb4DkVtmy9W1p  outpoint:16a6d115090531f47888834552c5556ce658e7c0966d158e2583f815549adae8:1
        sequence:fffffffe
   out  DUP HASH160 PUSHDATA(20)[ba91ed34ad92a7c2aa2d764c73cd0f31a18df680] EQUALVERIFY CHECKSIG  0.00483333 BTC
        P2PKH addr:mxXSnteng7Jkg3sc7xps6Nnw8jxEgLEBky
}
0200000001e8da9a5415f883258e156d96c0e758e66c55c55245838878f431050915d1a61601000000e00000004cdb6b6b766ba914b472a266d0bd89c13706a4132ccfb16f7c3b9fcb87636c766b827c75028000a267006863006c6c766b7c6c6c766b7c6b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352ae670068635167006c6c766b7c6c6c766b7c6b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352ae68feffffff0105600700000000001976a914ba91ed34ad92a7c2aa2d764c73cd0f31a18df68088ac60e31600


T8
Transaction{050fa40324703f9338f4b4892fa4ea68f4af402c089adcfdb2c9926072c8accc
weight: 2416 wu, 604 bytes
version 2
purpose: UNKNOWN
   in   0[] 0[] 0[] 0[] PUSHDATA2[6b6b6b766b827c756c6c766b7c6b827c7587636c766ba914b472a266d0bd89c13706a4132ccfb16f7c3b9fcb87670068636c766b827c75028000a2670068636c6c766b7c6ba914c51b66bced5e4491001bd702669770dccf44098287670068636c6c766b7c6b827c75028000a267006863006c6c6c766b7c6b7c6c6c6c766b7c6b7c6b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352ae6700686351676c766b827c756c6c766b7c6b827c758791636c766ba914b472a266d0bd89c13706a4132ccfb16f7c3b9fcb87670068636c766b827c75028000a2670068636c6c766b7c6ba914c51b66bced5e4491001bd702669770dccf44098287670068636c6c766b7c6b827c75028000a267006863006c6c6c766b7c6b7c6c6c6c766b7c6b7c6b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352ae67006868635167006c6c6c766b7c6b7c6c6c6c766b7c6b7c6b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352ae68]
        P2SH addr:2NCiXZnfdg6D3SuqY4KaTiVy2pGbSeqAxtu  outpoint:16a6d115090531f47888834552c5556ce658e7c0966d158e2583f815549adae8:2
   out  HASH160 PUSHDATA(20)[2e38f05e636989a28f71fe9be443f82e9ce3453e] EQUAL  0.00483333 BTC
        P2SH addr:2MwTdHJ4thrcqJLUuhKCnUoajqKCiuFsEyU
}
0200000001e8da9a5415f883258e156d96c0e758e66c55c55245838878f431050915d1a61602000000fd0702000000004d00026b6b6b766b827c756c6c766b7c6b827c7587636c766ba914b472a266d0bd89c13706a4132ccfb16f7c3b9fcb87670068636c766b827c75028000a2670068636c6c766b7c6ba914c51b66bced5e4491001bd702669770dccf44098287670068636c6c766b7c6b827c75028000a267006863006c6c6c766b7c6b7c6c6c6c766b7c6b7c6b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352ae6700686351676c766b827c756c6c766b7c6b827c758791636c766ba914b472a266d0bd89c13706a4132ccfb16f7c3b9fcb87670068636c766b827c75028000a2670068636c6c766b7c6ba914c51b66bced5e4491001bd702669770dccf44098287670068636c6c766b7c6b827c75028000a267006863006c6c6c766b7c6b7c6c6c6c766b7c6b7c6b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352ae67006868635167006c6c6c766b7c6b7c6c6c6c766b7c6b7c6b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352ae68ffffffff01056007000000000017a9142e38f05e636989a28f71fe9be443f82e9ce3453e8700000000


T9
Transaction{9c58c1ab9e4eb1aae1bfa34d0952ec71939b950a6fe9b498083d655010e7ec16
weight: 680 wu, 170 bytes
version 2
purpose: UNKNOWN
   in   0[] 0[] PUSHDATA1[6b6b006c766c766b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352ae]
        P2SH addr:2MwTdHJ4thrcqJLUuhKCnUoajqKCiuFsEyU  outpoint:050fa40324703f9338f4b4892fa4ea68f4af402c089adcfdb2c9926072c8accc:0
   out  DUP HASH160 PUSHDATA(20)[448f9bd84d520fb00adb83f26d8a78ddc5403c89] EQUALVERIFY CHECKSIG  0.00453333 BTC
        P2PKH addr:mmmUHDB4rQasyk5FszofhjfEW9vHuZM5Lz
}
0200000001ccacc8726092c9b2fddc9a082c40aff468eaa42f89b4f438933f702403a40f05000000005500004c516b6b006c766c766b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352aeffffffff01d5ea0600000000001976a914448f9bd84d520fb00adb83f26d8a78ddc5403c8988ac00000000


T10
Transaction{050fa40324703f9338f4b4892fa4ea68f4af402c089adcfdb2c9926072c8accc
weight: 2416 wu, 604 bytes
version 2
purpose: UNKNOWN
   in   0[] 0[] 0[] 0[] PUSHDATA2[6b6b6b766b827c756c6c766b7c6b827c7587636c766ba914b472a266d0bd89c13706a4132ccfb16f7c3b9fcb87670068636c766b827c75028000a2670068636c6c766b7c6ba914c51b66bced5e4491001bd702669770dccf44098287670068636c6c766b7c6b827c75028000a267006863006c6c6c766b7c6b7c6c6c6c766b7c6b7c6b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352ae6700686351676c766b827c756c6c766b7c6b827c758791636c766ba914b472a266d0bd89c13706a4132ccfb16f7c3b9fcb87670068636c766b827c75028000a2670068636c6c766b7c6ba914c51b66bced5e4491001bd702669770dccf44098287670068636c6c766b7c6b827c75028000a267006863006c6c6c766b7c6b7c6c6c6c766b7c6b7c6b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352ae67006868635167006c6c6c766b7c6b7c6c6c6c766b7c6b7c6b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352ae68]
        P2SH addr:2NCiXZnfdg6D3SuqY4KaTiVy2pGbSeqAxtu  outpoint:16a6d115090531f47888834552c5556ce658e7c0966d158e2583f815549adae8:2
   out  HASH160 PUSHDATA(20)[2e38f05e636989a28f71fe9be443f82e9ce3453e] EQUAL  0.00483333 BTC
        P2SH addr:2MwTdHJ4thrcqJLUuhKCnUoajqKCiuFsEyU
}
0200000001e8da9a5415f883258e156d96c0e758e66c55c55245838878f431050915d1a61602000000fd0702000000004d00026b6b6b766b827c756c6c766b7c6b827c7587636c766ba914b472a266d0bd89c13706a4132ccfb16f7c3b9fcb87670068636c766b827c75028000a2670068636c6c766b7c6ba914c51b66bced5e4491001bd702669770dccf44098287670068636c6c766b7c6b827c75028000a267006863006c6c6c766b7c6b7c6c6c6c766b7c6b7c6b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352ae6700686351676c766b827c756c6c766b7c6b827c758791636c766ba914b472a266d0bd89c13706a4132ccfb16f7c3b9fcb87670068636c766b827c75028000a2670068636c6c766b7c6ba914c51b66bced5e4491001bd702669770dccf44098287670068636c6c766b7c6b827c75028000a267006863006c6c6c766b7c6b7c6c6c6c766b7c6b7c6b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352ae67006868635167006c6c6c766b7c6b7c6c6c6c766b7c6b7c6b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352ae68ffffffff01056007000000000017a9142e38f05e636989a28f71fe9be443f82e9ce3453e8700000000


T11
Transaction{f721d55c0b675fbe279ee7cc60a2013362fcfea83041a6a5b8453a518a755e5e
weight: 680 wu, 170 bytes
version 2
purpose: UNKNOWN
   in   0[] 0[] PUSHDATA1[6b6b006c766c766b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352ae]
        P2SH addr:2MwTdHJ4thrcqJLUuhKCnUoajqKCiuFsEyU  outpoint:050fa40324703f9338f4b4892fa4ea68f4af402c089adcfdb2c9926072c8accc:0
   out  DUP HASH160 PUSHDATA(20)[ba91ed34ad92a7c2aa2d764c73cd0f31a18df680] EQUALVERIFY CHECKSIG  0.00453333 BTC
        P2PKH addr:mxXSnteng7Jkg3sc7xps6Nnw8jxEgLEBky
}
0200000001ccacc8726092c9b2fddc9a082c40aff468eaa42f89b4f438933f702403a40f05000000005500004c516b6b006c766c766b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352aeffffffff01d5ea0600000000001976a914ba91ed34ad92a7c2aa2d764c73cd0f31a18df68088ac00000000


T12
Transaction{c4f85792315c333d3c2dd3f9d9319c285ce8446ee21b8e04c5a7b1510b8450d1
weight: 2544 wu, 636 bytes
version 2
time locked until block 1500000
purpose: UNKNOWN
   in   0[] 0[] 0[] 0[] PUSHDATA2[6b6b6b766b827c756c6c766b7c6b827c7587636c766ba914b472a266d0bd89c13706a4132ccfb16f7c3b9fcb87670068636c766b827c75028000a2670068636c6c766b7c6ba914c51b66bced5e4491001bd702669770dccf44098287670068636c6c766b7c6b827c75028000a267006863006c6c6c766b7c6b7c6c6c6c766b7c6b7c6b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352ae6700686351676c766b827c756c6c766b7c6b827c758791636c766ba914b472a266d0bd89c13706a4132ccfb16f7c3b9fcb87670068636c766b827c75028000a2670068636c6c766b7c6ba914c51b66bced5e4491001bd702669770dccf44098287670068636c6c766b7c6b827c75028000a267006863006c6c6c766b7c6b7c6c6c6c766b7c6b7c6b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352ae67006868635167006c6c6c766b7c6b7c6c6c6c766b7c6b7c6b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352ae68]
        P2SH addr:2NCiXZnfdg6D3SuqY4KaTiVy2pGbSeqAxtu  outpoint:16a6d115090531f47888834552c5556ce658e7c0966d158e2583f815549adae8:2
        sequence:fffffffe
   out  HASH160 PUSHDATA(20)[2e38f05e636989a28f71fe9be443f82e9ce3453e] EQUAL  0.00241666 BTC
        P2SH addr:2MwTdHJ4thrcqJLUuhKCnUoajqKCiuFsEyU
   out  HASH160 PUSHDATA(20)[2e38f05e636989a28f71fe9be443f82e9ce3453e] EQUAL  0.00241666 BTC
        P2SH addr:2MwTdHJ4thrcqJLUuhKCnUoajqKCiuFsEyU
}
0200000001e8da9a5415f883258e156d96c0e758e66c55c55245838878f431050915d1a61602000000fd0702000000004d00026b6b6b766b827c756c6c766b7c6b827c7587636c766ba914b472a266d0bd89c13706a4132ccfb16f7c3b9fcb87670068636c766b827c75028000a2670068636c6c766b7c6ba914c51b66bced5e4491001bd702669770dccf44098287670068636c6c766b7c6b827c75028000a267006863006c6c6c766b7c6b7c6c6c6c766b7c6b7c6b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352ae6700686351676c766b827c756c6c766b7c6b827c758791636c766ba914b472a266d0bd89c13706a4132ccfb16f7c3b9fcb87670068636c766b827c75028000a2670068636c6c766b7c6ba914c51b66bced5e4491001bd702669770dccf44098287670068636c6c766b7c6b827c75028000a267006863006c6c6c766b7c6b7c6c6c6c766b7c6b7c6b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352ae67006868635167006c6c6c766b7c6b7c6c6c6c766b7c6b7c6b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352ae68feffffff0202b003000000000017a9142e38f05e636989a28f71fe9be443f82e9ce3453e8702b003000000000017a9142e38f05e636989a28f71fe9be443f82e9ce3453e8760e31600


T13
Transaction{51a8513022ed991623f20b994e43f39df5527dfbb1c1c24326c2dfe3a7dfa7c4
weight: 680 wu, 170 bytes
version 2
purpose: UNKNOWN
   in   0[] 0[] PUSHDATA1[6b6b006c766c766b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352ae]
        P2SH addr:2MwTdHJ4thrcqJLUuhKCnUoajqKCiuFsEyU  outpoint:c4f85792315c333d3c2dd3f9d9319c285ce8446ee21b8e04c5a7b1510b8450d1:0
   out  DUP HASH160 PUSHDATA(20)[448f9bd84d520fb00adb83f26d8a78ddc5403c89] EQUALVERIFY CHECKSIG  0.00211666 BTC
        P2PKH addr:mmmUHDB4rQasyk5FszofhjfEW9vHuZM5Lz
}
0200000001d150840b51b1a7c5048e1be26e44e85c289c31d9f9d32d3c3d335c319257f8c4000000005500004c516b6b006c766c766b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352aeffffffff01d23a0300000000001976a914448f9bd84d520fb00adb83f26d8a78ddc5403c8988ac00000000


T14
Transaction{3e81f0351f573bc49fd361c43e8fd6f6ca6b31492ccf606dcc46bd0ce87105f8
weight: 680 wu, 170 bytes
version 2
purpose: UNKNOWN
   in   0[] 0[] PUSHDATA1[6b6b006c766c766b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352ae]
        P2SH addr:2MwTdHJ4thrcqJLUuhKCnUoajqKCiuFsEyU  outpoint:c4f85792315c333d3c2dd3f9d9319c285ce8446ee21b8e04c5a7b1510b8450d1:1
   out  DUP HASH160 PUSHDATA(20)[ba91ed34ad92a7c2aa2d764c73cd0f31a18df680] EQUALVERIFY CHECKSIG  0.00211666 BTC
        P2PKH addr:mxXSnteng7Jkg3sc7xps6Nnw8jxEgLEBky
}
0200000001d150840b51b1a7c5048e1be26e44e85c289c31d9f9d32d3c3d335c319257f8c4010000005500004c516b6b006c766c766b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352aeffffffff01d23a0300000000001976a914ba91ed34ad92a7c2aa2d764c73cd0f31a18df68088ac00000000

Initial state:

Participants:
A,B

TXs:
Tinit, T1, T2, ... T14 (all without any baked-in signatures or secrets) (PS: it may be acceptable to bake in private-level secrets for individual views.)

Meta:
Tinit : P2PKH sigs from A for txA, B for txB and txFee (chunks 0 of indexes 0,1,2)
T1: P2SH (Tinit) sigs from A and B (chunks 0,1 of index 0)
T2: P2SH (T1) sigs from A and B (chunks 0,1 of index 0)
  ...
     */
    implicit val timeout : Timeout = 1 second

    // Build initial state. This might look large here, but it should be significantly easier to build the JSON on the compiler side in a real use case.

    val a_priv = PrivateKey.fromBase58("cSthBXr8YQAexpKeh22LB9PdextVE1UJeahmyns5LzcmMDSy59L4", Base58.Prefix.SecretKeyTestnet)._1
    val a_pub = a_priv.publicKey
    println(a_pub)
    val alice_p = Participant("Alice", List(a_pub), Address("akka", "test", "127.0.0.1", 25000))
    val b_priv = PrivateKey.fromBase58("cQmSz3Tj3usor9byskhpCTfrmCM5cLetLU9Xw6y2csYhxSbKDzUn", Base58.Prefix.SecretKeyTestnet)._1
    val b_pub = b_priv.publicKey
    println(b_pub)
    val bob_p = Participant("Bob", List(b_pub), Address("akka", "test", "127.0.0.1", 25001))

    val partdb = new ParticipantStorage()
    partdb.save(alice_p)
    partdb.save(bob_p)

    val tinit_raw = Transaction.read("02000000034ebd9948a3b44846de67815e6cdf32edf2924dad4c03f62276fcced295f997f90100000023002102a6d35321c8930c1da17df79edebaf13192ee3e39c9abcea6d8dd9c5f3640e2abffffffffe46349e58df3e00db58938cd5f9ffcda1fad16afb23f908f2eee9ac93d78a1480100000023002102a6d35321c8930c1da17df79edebaf13192ee3e39c9abcea6d8dd9c5f3640e2abffffffffcf7c7752c144dfc8093918ba01c4d3d8a13107583f5f4502d211a651266dbcc30000000023002102a6d35321c8930c1da17df79edebaf13192ee3e39c9abcea6d8dd9c5f3640e2abffffffff01cff417000000000017a9142e38f05e636989a28f71fe9be443f82e9ce3453e8700000000")
    val t1_raw = Transaction.read("0200000001018e004e075be6692fa53694c6cc0811b9c54d1f7d2392c1eb35ceeb9fb92a5e000000005500004c516b6b006c766c766b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352aeffffffff0335d507000000000017a9145d47e7c94f98c7462298a1fd74438e2edc9bdc488735d507000000000017a9145c77a7884016e20b07be95bcfab9f63a5926e92e8735d507000000000017a914d5944b405abb7dc532047245952eca7bd9116a6e8700000000")
    val t2_raw = Transaction.read("0200000001e8da9a5415f883258e156d96c0e758e66c55c55245838878f431050915d1a61600000000f10000004cec6b6b766b827c75028000940052a5636c766ba914c51b66bced5e4491001bd702669770dccf44098287670068636c766b827c75028000a267006863006c6c766b7c6c6c766b7c6b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352ae670068635167006c6c766b7c6c6c766b7c6b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352ae68ffffffff01056007000000000017a9142e38f05e636989a28f71fe9be443f82e9ce3453e8700000000")
    val t3_raw = Transaction.read("0200000001fa6c2e1e1402a9399518baff5936f31cb6ab13ed6b2ed247bf0a301ef9e123bd000000005500004c516b6b006c766c766b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352aeffffffff01d5ea0600000000001976a914ba91ed34ad92a7c2aa2d764c73cd0f31a18df68088ac00000000")
    val t4_raw = Transaction.read("0200000001e8da9a5415f883258e156d96c0e758e66c55c55245838878f431050915d1a61600000000f10000004cec6b6b766b827c75028000940052a5636c766ba914c51b66bced5e4491001bd702669770dccf44098287670068636c766b827c75028000a267006863006c6c766b7c6c6c766b7c6b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352ae670068635167006c6c766b7c6c6c766b7c6b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352ae68feffffff0105600700000000001976a914448f9bd84d520fb00adb83f26d8a78ddc5403c8988ac60e31600")
    val t5_raw = Transaction.read("0200000001e8da9a5415f883258e156d96c0e758e66c55c55245838878f431050915d1a61601000000e00000004cdb6b6b766ba914b472a266d0bd89c13706a4132ccfb16f7c3b9fcb87636c766b827c75028000a267006863006c6c766b7c6c6c766b7c6b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352ae670068635167006c6c766b7c6c6c766b7c6b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352ae68ffffffff01056007000000000017a9142e38f05e636989a28f71fe9be443f82e9ce3453e8700000000")
    val t6_raw = Transaction.read("0200000001e03c982aab19cdeb209277f1031a09961240508af78245bc3ec86d08070cca76000000005500004c516b6b006c766c766b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352aeffffffff01d5ea0600000000001976a914448f9bd84d520fb00adb83f26d8a78ddc5403c8988ac00000000")
    val t7_raw = Transaction.read("0200000001e8da9a5415f883258e156d96c0e758e66c55c55245838878f431050915d1a61601000000e00000004cdb6b6b766ba914b472a266d0bd89c13706a4132ccfb16f7c3b9fcb87636c766b827c75028000a267006863006c6c766b7c6c6c766b7c6b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352ae670068635167006c6c766b7c6c6c766b7c6b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352ae68feffffff0105600700000000001976a914ba91ed34ad92a7c2aa2d764c73cd0f31a18df68088ac60e31600")
    val t8_raw = Transaction.read("0200000001e8da9a5415f883258e156d96c0e758e66c55c55245838878f431050915d1a61602000000fd0702000000004d00026b6b6b766b827c756c6c766b7c6b827c7587636c766ba914b472a266d0bd89c13706a4132ccfb16f7c3b9fcb87670068636c766b827c75028000a2670068636c6c766b7c6ba914c51b66bced5e4491001bd702669770dccf44098287670068636c6c766b7c6b827c75028000a267006863006c6c6c766b7c6b7c6c6c6c766b7c6b7c6b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352ae6700686351676c766b827c756c6c766b7c6b827c758791636c766ba914b472a266d0bd89c13706a4132ccfb16f7c3b9fcb87670068636c766b827c75028000a2670068636c6c766b7c6ba914c51b66bced5e4491001bd702669770dccf44098287670068636c6c766b7c6b827c75028000a267006863006c6c6c766b7c6b7c6c6c6c766b7c6b7c6b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352ae67006868635167006c6c6c766b7c6b7c6c6c6c766b7c6b7c6b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352ae68ffffffff01056007000000000017a9142e38f05e636989a28f71fe9be443f82e9ce3453e8700000000")
    val t9_raw = Transaction.read("0200000001ccacc8726092c9b2fddc9a082c40aff468eaa42f89b4f438933f702403a40f05000000005500004c516b6b006c766c766b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352aeffffffff01d5ea0600000000001976a914448f9bd84d520fb00adb83f26d8a78ddc5403c8988ac00000000")
    val t10_raw = Transaction.read("0200000001e8da9a5415f883258e156d96c0e758e66c55c55245838878f431050915d1a61602000000fd0702000000004d00026b6b6b766b827c756c6c766b7c6b827c7587636c766ba914b472a266d0bd89c13706a4132ccfb16f7c3b9fcb87670068636c766b827c75028000a2670068636c6c766b7c6ba914c51b66bced5e4491001bd702669770dccf44098287670068636c6c766b7c6b827c75028000a267006863006c6c6c766b7c6b7c6c6c6c766b7c6b7c6b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352ae6700686351676c766b827c756c6c766b7c6b827c758791636c766ba914b472a266d0bd89c13706a4132ccfb16f7c3b9fcb87670068636c766b827c75028000a2670068636c6c766b7c6ba914c51b66bced5e4491001bd702669770dccf44098287670068636c6c766b7c6b827c75028000a267006863006c6c6c766b7c6b7c6c6c6c766b7c6b7c6b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352ae67006868635167006c6c6c766b7c6b7c6c6c6c766b7c6b7c6b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352ae68ffffffff01056007000000000017a9142e38f05e636989a28f71fe9be443f82e9ce3453e8700000000")
    val t11_raw = Transaction.read("0200000001ccacc8726092c9b2fddc9a082c40aff468eaa42f89b4f438933f702403a40f05000000005500004c516b6b006c766c766b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352aeffffffff01d5ea0600000000001976a914ba91ed34ad92a7c2aa2d764c73cd0f31a18df68088ac00000000")
    val t12_raw = Transaction.read("0200000001e8da9a5415f883258e156d96c0e758e66c55c55245838878f431050915d1a61602000000fd0702000000004d00026b6b6b766b827c756c6c766b7c6b827c7587636c766ba914b472a266d0bd89c13706a4132ccfb16f7c3b9fcb87670068636c766b827c75028000a2670068636c6c766b7c6ba914c51b66bced5e4491001bd702669770dccf44098287670068636c6c766b7c6b827c75028000a267006863006c6c6c766b7c6b7c6c6c6c766b7c6b7c6b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352ae6700686351676c766b827c756c6c766b7c6b827c758791636c766ba914b472a266d0bd89c13706a4132ccfb16f7c3b9fcb87670068636c766b827c75028000a2670068636c6c766b7c6ba914c51b66bced5e4491001bd702669770dccf44098287670068636c6c766b7c6b827c75028000a267006863006c6c6c766b7c6b7c6c6c6c766b7c6b7c6b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352ae67006868635167006c6c6c766b7c6b7c6c6c6c766b7c6b7c6b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352ae68feffffff0202b003000000000017a9142e38f05e636989a28f71fe9be443f82e9ce3453e8702b003000000000017a9142e38f05e636989a28f71fe9be443f82e9ce3453e8760e31600")
    val t13_raw = Transaction.read("0200000001d150840b51b1a7c5048e1be26e44e85c289c31d9f9d32d3c3d335c319257f8c4000000005500004c516b6b006c766c766b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352aeffffffff01d23a0300000000001976a914448f9bd84d520fb00adb83f26d8a78ddc5403c8988ac00000000")
    val t14_raw = Transaction.read("0200000001d150840b51b1a7c5048e1be26e44e85c289c31d9f9d32d3c3d335c319257f8c4010000005500004c516b6b006c766c766b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352aeffffffff01d23a0300000000001976a914ba91ed34ad92a7c2aa2d764c73cd0f31a18df68088ac00000000")

    val txdb = new TxStorage()
    txdb.save("Tinit", tinit_raw)
    txdb.save("T1", t1_raw)
    txdb.save("T2", t2_raw)
    txdb.save("T3", t3_raw)
    txdb.save("T4", t4_raw)
    txdb.save("T5", t5_raw)
    txdb.save("T6", t6_raw)
    txdb.save("T7", t7_raw)
    txdb.save("T8", t8_raw)
    txdb.save("T9", t9_raw)
    txdb.save("T10", t10_raw)
    txdb.save("T11", t11_raw)
    txdb.save("T12", t12_raw)
    txdb.save("T13", t13_raw)
    txdb.save("T14", t14_raw)

    val tinit0_chunks = Seq(
      ChunkEntry(chunkType = ChunkType.SIG_P2PKH, chunkPrivacy= ChunkPrivacy.AUTH, chunkIndex = 0, owner = Option(b_pub), data = ByteVector.empty))
    val tinit1_chunks = Seq(
      ChunkEntry(chunkType = ChunkType.SIG_P2PKH, chunkPrivacy= ChunkPrivacy.AUTH, chunkIndex = 0, owner = Option(a_pub), data = ByteVector.empty))
    val tinit2_chunks = Seq(
      ChunkEntry(chunkType = ChunkType.SIG_P2PKH, chunkPrivacy= ChunkPrivacy.AUTH, chunkIndex = 0, owner = Option(b_pub), data = ByteVector.empty))
    val t1_chunks = Seq(
      ChunkEntry(chunkType = ChunkType.SIG_P2SH, chunkPrivacy= ChunkPrivacy.PUBLIC, chunkIndex = 0, owner = Option(b_pub), data = ByteVector.empty),
      ChunkEntry(chunkType = ChunkType.SIG_P2SH, chunkPrivacy= ChunkPrivacy.PUBLIC, chunkIndex = 1, owner = Option(a_pub), data = ByteVector.empty)
    )
    // First split: B secret
    val t2_chunks = Seq(
      ChunkEntry(chunkType = ChunkType.SECRET_IN, chunkPrivacy= ChunkPrivacy.PRIVATE, chunkIndex = 0, owner = Option(b_pub), data = ByteVector.empty),
      ChunkEntry(chunkType = ChunkType.SIG_P2SH, chunkPrivacy= ChunkPrivacy.PUBLIC, chunkIndex = 1, owner = Option(b_pub), data = ByteVector.empty),
      ChunkEntry(chunkType = ChunkType.SIG_P2SH, chunkPrivacy= ChunkPrivacy.PUBLIC, chunkIndex = 2, owner = Option(a_pub), data = ByteVector.empty)
    )
    val t3_chunks = Seq(
      ChunkEntry(chunkType = ChunkType.SIG_P2SH, chunkPrivacy= ChunkPrivacy.PUBLIC, chunkIndex = 0, owner = Option(b_pub), data = ByteVector.empty),
      ChunkEntry(chunkType = ChunkType.SIG_P2SH, chunkPrivacy= ChunkPrivacy.PUBLIC, chunkIndex = 1, owner = Option(a_pub), data = ByteVector.empty)
    )
    val t4_chunks = Seq(
      ChunkEntry(chunkType = ChunkType.SECRET_IN, chunkPrivacy= ChunkPrivacy.PRIVATE, chunkIndex = 0, owner = Option(b_pub), data = ByteVector.fromValidHex("00")),
      ChunkEntry(chunkType = ChunkType.SIG_P2SH, chunkPrivacy= ChunkPrivacy.PUBLIC, chunkIndex = 1, owner = Option(b_pub), data = ByteVector.empty),
      ChunkEntry(chunkType = ChunkType.SIG_P2SH, chunkPrivacy= ChunkPrivacy.PUBLIC, chunkIndex = 2, owner = Option(a_pub), data = ByteVector.empty)
    )
    // Second split: A secret
    val t5_chunks = Seq(
      ChunkEntry(chunkType = ChunkType.SECRET_IN, chunkPrivacy= ChunkPrivacy.PRIVATE, chunkIndex = 0, owner = Option(a_pub), data = ByteVector.empty),
      ChunkEntry(chunkType = ChunkType.SIG_P2SH, chunkPrivacy= ChunkPrivacy.PUBLIC, chunkIndex = 1, owner = Option(b_pub), data = ByteVector.empty),
      ChunkEntry(chunkType = ChunkType.SIG_P2SH, chunkPrivacy= ChunkPrivacy.PUBLIC, chunkIndex = 2, owner = Option(a_pub), data = ByteVector.empty)
    )
    val t6_chunks = Seq(
      ChunkEntry(chunkType = ChunkType.SIG_P2SH, chunkPrivacy= ChunkPrivacy.PUBLIC, chunkIndex = 0, owner = Option(b_pub), data = ByteVector.empty),
      ChunkEntry(chunkType = ChunkType.SIG_P2SH, chunkPrivacy= ChunkPrivacy.PUBLIC, chunkIndex = 1, owner = Option(a_pub), data = ByteVector.empty)
    )
    val t7_chunks = Seq(
      ChunkEntry(chunkType = ChunkType.SECRET_IN, chunkPrivacy= ChunkPrivacy.PRIVATE, chunkIndex = 0, owner = Option(a_pub), data = ByteVector.fromValidHex("00")),
      ChunkEntry(chunkType = ChunkType.SIG_P2SH, chunkPrivacy= ChunkPrivacy.PUBLIC, chunkIndex = 1, owner = Option(b_pub), data = ByteVector.empty),
      ChunkEntry(chunkType = ChunkType.SIG_P2SH, chunkPrivacy= ChunkPrivacy.PUBLIC, chunkIndex = 2, owner = Option(a_pub), data = ByteVector.empty)
    )
    // Third split: match sec_a sec_b.
    // TODO: Should each participant grab the opposite participant's secret from T2/T5 respectively? (currently unimplemented RPC lookup)
    //  Or can we trust to just ask them? (switch private blocks in t8 and t10 to public)
    // Temporarily implemented the latter
    val t8_chunks = Seq(
      ChunkEntry(chunkType = ChunkType.SECRET_IN, chunkPrivacy= ChunkPrivacy.PUBLIC, chunkIndex = 0, owner = Option(a_pub), data = ByteVector.empty),
      ChunkEntry(chunkType = ChunkType.SECRET_IN, chunkPrivacy= ChunkPrivacy.PUBLIC, chunkIndex = 0, owner = Option(b_pub), data = ByteVector.empty),
      ChunkEntry(chunkType = ChunkType.SIG_P2SH, chunkPrivacy= ChunkPrivacy.PUBLIC, chunkIndex = 1, owner = Option(b_pub), data = ByteVector.empty),
      ChunkEntry(chunkType = ChunkType.SIG_P2SH, chunkPrivacy= ChunkPrivacy.PUBLIC, chunkIndex = 2, owner = Option(a_pub), data = ByteVector.empty)
    )
    val t9_chunks = Seq(
      ChunkEntry(chunkType = ChunkType.SIG_P2SH, chunkPrivacy= ChunkPrivacy.PUBLIC, chunkIndex = 0, owner = Option(b_pub), data = ByteVector.empty),
      ChunkEntry(chunkType = ChunkType.SIG_P2SH, chunkPrivacy= ChunkPrivacy.PUBLIC, chunkIndex = 1, owner = Option(a_pub), data = ByteVector.empty)
    )
    val t10_chunks = Seq(
      ChunkEntry(chunkType = ChunkType.SECRET_IN, chunkPrivacy= ChunkPrivacy.PUBLIC, chunkIndex = 0, owner = Option(a_pub), data = ByteVector.empty),
      ChunkEntry(chunkType = ChunkType.SECRET_IN, chunkPrivacy= ChunkPrivacy.PUBLIC, chunkIndex = 0, owner = Option(b_pub), data = ByteVector.empty),
      ChunkEntry(chunkType = ChunkType.SIG_P2SH, chunkPrivacy= ChunkPrivacy.PUBLIC, chunkIndex = 1, owner = Option(b_pub), data = ByteVector.empty),
      ChunkEntry(chunkType = ChunkType.SIG_P2SH, chunkPrivacy= ChunkPrivacy.PUBLIC, chunkIndex = 2, owner = Option(a_pub), data = ByteVector.empty)
    )
    val t11_chunks = Seq(
      ChunkEntry(chunkType = ChunkType.SIG_P2SH, chunkPrivacy= ChunkPrivacy.PUBLIC, chunkIndex = 0, owner = Option(b_pub), data = ByteVector.empty),
      ChunkEntry(chunkType = ChunkType.SIG_P2SH, chunkPrivacy= ChunkPrivacy.PUBLIC, chunkIndex = 1, owner = Option(a_pub), data = ByteVector.empty)
    )
    val t12_chunks = Seq(
      ChunkEntry(chunkType = ChunkType.SECRET_IN, chunkPrivacy= ChunkPrivacy.PUBLIC, chunkIndex = 0, owner = Option(a_pub), data = ByteVector.fromValidHex("00")),
      ChunkEntry(chunkType = ChunkType.SECRET_IN, chunkPrivacy= ChunkPrivacy.PUBLIC, chunkIndex = 0, owner = Option(b_pub), data = ByteVector.fromValidHex("00")),
      ChunkEntry(chunkType = ChunkType.SIG_P2SH, chunkPrivacy= ChunkPrivacy.PUBLIC, chunkIndex = 1, owner = Option(b_pub), data = ByteVector.empty),
      ChunkEntry(chunkType = ChunkType.SIG_P2SH, chunkPrivacy= ChunkPrivacy.PUBLIC, chunkIndex = 2, owner = Option(a_pub), data = ByteVector.empty)
    )
    val t13_chunks = Seq(
      ChunkEntry(chunkType = ChunkType.SIG_P2SH, chunkPrivacy= ChunkPrivacy.PUBLIC, chunkIndex = 0, owner = Option(b_pub), data = ByteVector.empty),
      ChunkEntry(chunkType = ChunkType.SIG_P2SH, chunkPrivacy= ChunkPrivacy.PUBLIC, chunkIndex = 1, owner = Option(a_pub), data = ByteVector.empty)
    )
    val t14_chunks = Seq(
      ChunkEntry(chunkType = ChunkType.SIG_P2SH, chunkPrivacy= ChunkPrivacy.PUBLIC, chunkIndex = 0, owner = Option(b_pub), data = ByteVector.empty),
      ChunkEntry(chunkType = ChunkType.SIG_P2SH, chunkPrivacy= ChunkPrivacy.PUBLIC, chunkIndex = 1, owner = Option(a_pub), data = ByteVector.empty)
    )

    val tinit_entry = TxEntry(name = "Tinit", indexData = Map(
      0 -> IndexEntry(amt = Satoshi(300000) ,chunkData = tinit0_chunks),
      1 -> IndexEntry(amt = Satoshi(300000) ,chunkData = tinit1_chunks),
      2 -> IndexEntry(amt = Satoshi(1000000) ,chunkData = tinit2_chunks)))
    val t1_entry = TxEntry(name = "T1", indexData = Map(0 -> IndexEntry(amt = Satoshi(1569999) ,chunkData = t1_chunks)))
    val t2_entry = TxEntry(name = "T2", indexData = Map(0 -> IndexEntry(amt = Satoshi(513333) ,chunkData = t2_chunks)))
    val t3_entry = TxEntry(name = "T3", indexData = Map(0 -> IndexEntry(amt = Satoshi(483333) ,chunkData = t3_chunks)))
    val t4_entry = TxEntry(name = "T4", indexData = Map(0 -> IndexEntry(amt = Satoshi(513333) ,chunkData = t4_chunks)))
    val t5_entry = TxEntry(name = "T5", indexData = Map(0 -> IndexEntry(amt = Satoshi(513333) ,chunkData = t5_chunks)))
    val t6_entry = TxEntry(name = "T6", indexData = Map(0 -> IndexEntry(amt = Satoshi(483333) ,chunkData = t6_chunks)))
    val t7_entry = TxEntry(name = "T7", indexData = Map(0 -> IndexEntry(amt = Satoshi(513333) ,chunkData = t7_chunks)))
    val t8_entry = TxEntry(name = "T8", indexData = Map(0 -> IndexEntry(amt = Satoshi(513333) ,chunkData = t8_chunks)))
    val t9_entry = TxEntry(name = "T9", indexData = Map(0 -> IndexEntry(amt = Satoshi(483333) ,chunkData = t9_chunks)))
    val t10_entry = TxEntry(name = "T10", indexData = Map(0 -> IndexEntry(amt = Satoshi(513333) ,chunkData = t10_chunks)))
    val t11_entry = TxEntry(name = "T11", indexData = Map(0 -> IndexEntry(amt = Satoshi(483333) ,chunkData = t11_chunks)))
    val t12_entry = TxEntry(name = "T12", indexData = Map(0 -> IndexEntry(amt = Satoshi(513333) ,chunkData = t12_chunks)))
    val t13_entry = TxEntry(name = "T13", indexData = Map(0 -> IndexEntry(amt = Satoshi(241666) ,chunkData = t13_chunks)))
    val t14_entry = TxEntry(name = "T14", indexData = Map(0 -> IndexEntry(amt = Satoshi(241666) ,chunkData = t14_chunks)))

    val metadb = new MetaStorage()
    metadb.save(tinit_entry)
    metadb.save(t1_entry)
    metadb.save(t2_entry)
    metadb.save(t3_entry)
    metadb.save(t4_entry)
    metadb.save(t5_entry)
    metadb.save(t6_entry)
    metadb.save(t7_entry)
    metadb.save(t8_entry)
    metadb.save(t9_entry)
    metadb.save(t10_entry)
    metadb.save(t11_entry)
    metadb.save(t12_entry)
    metadb.save(t13_entry)
    metadb.save(t14_entry)

    val stateSerializer =  new Serializer(ChunkPrivacy.PRIVATE)

    val blankState = stateSerializer.prettyPrintState(State(partdb, txdb, metadb))

    // Build B view
    val b_secret = ByteVector.fromValidHex("3030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303031")

    val t2_b = Seq(
      ChunkEntry(chunkType = ChunkType.SECRET_IN, chunkPrivacy= ChunkPrivacy.PRIVATE, chunkIndex = 0, owner = Option(b_pub), data = b_secret),
      ChunkEntry(chunkType = ChunkType.SIG_P2SH, chunkPrivacy= ChunkPrivacy.PUBLIC, chunkIndex = 1, owner = Option(b_pub), data = ByteVector.empty),
      ChunkEntry(chunkType = ChunkType.SIG_P2SH, chunkPrivacy= ChunkPrivacy.PUBLIC, chunkIndex = 2, owner = Option(a_pub), data = ByteVector.empty)
    )
    // T8 and T10 might look different depending on the note above.
    val t8_b = Seq(
      ChunkEntry(chunkType = ChunkType.SECRET_IN, chunkPrivacy= ChunkPrivacy.PUBLIC, chunkIndex = 0, owner = Option(a_pub), data = ByteVector.empty),
      ChunkEntry(chunkType = ChunkType.SECRET_IN, chunkPrivacy= ChunkPrivacy.PUBLIC, chunkIndex = 0, owner = Option(b_pub), data = b_secret),
      ChunkEntry(chunkType = ChunkType.SIG_P2SH, chunkPrivacy= ChunkPrivacy.PUBLIC, chunkIndex = 1, owner = Option(b_pub), data = ByteVector.empty),
      ChunkEntry(chunkType = ChunkType.SIG_P2SH, chunkPrivacy= ChunkPrivacy.PUBLIC, chunkIndex = 2, owner = Option(a_pub), data = ByteVector.empty)
    )
    val t10_b = Seq(
      ChunkEntry(chunkType = ChunkType.SECRET_IN, chunkPrivacy= ChunkPrivacy.PUBLIC, chunkIndex = 0, owner = Option(a_pub), data = ByteVector.empty),
      ChunkEntry(chunkType = ChunkType.SECRET_IN, chunkPrivacy= ChunkPrivacy.PUBLIC, chunkIndex = 0, owner = Option(b_pub), data = b_secret),
      ChunkEntry(chunkType = ChunkType.SIG_P2SH, chunkPrivacy= ChunkPrivacy.PUBLIC, chunkIndex = 1, owner = Option(b_pub), data = ByteVector.empty),
      ChunkEntry(chunkType = ChunkType.SIG_P2SH, chunkPrivacy= ChunkPrivacy.PUBLIC, chunkIndex = 2, owner = Option(a_pub), data = ByteVector.empty)
    )
    val t2_entry_b = TxEntry(name = "T2", indexData = Map(0 -> IndexEntry(amt = Satoshi(513333) ,chunkData = t2_b)))
    val t8_entry_b = TxEntry(name = "T8", indexData = Map(0 -> IndexEntry(amt = Satoshi(513333) ,chunkData = t8_b)))
    val t10_entry_b = TxEntry(name = "T10", indexData = Map(0 -> IndexEntry(amt = Satoshi(513333) ,chunkData = t10_b)))
    metadb.save(t2_entry_b)
    metadb.save(t8_entry_b)
    metadb.save(t10_entry_b)

    val b_view = stateSerializer.prettyPrintState(State(partdb, txdb, metadb))

    // Build A view
    val a_secret = ByteVector.fromValidHex("3030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030")

    val t5_a = Seq(
      ChunkEntry(chunkType = ChunkType.SECRET_IN, chunkPrivacy= ChunkPrivacy.PRIVATE, chunkIndex = 0, owner = Option(a_pub), data = a_secret),
      ChunkEntry(chunkType = ChunkType.SIG_P2SH, chunkPrivacy= ChunkPrivacy.PUBLIC, chunkIndex = 1, owner = Option(b_pub), data = ByteVector.empty),
      ChunkEntry(chunkType = ChunkType.SIG_P2SH, chunkPrivacy= ChunkPrivacy.PUBLIC, chunkIndex = 2, owner = Option(a_pub), data = ByteVector.empty)
    )
    // T8 and T10 might look different depending on the note above.
    val t8_a = Seq(
      ChunkEntry(chunkType = ChunkType.SECRET_IN, chunkPrivacy= ChunkPrivacy.PUBLIC, chunkIndex = 0, owner = Option(a_pub), data = a_secret),
      ChunkEntry(chunkType = ChunkType.SECRET_IN, chunkPrivacy= ChunkPrivacy.PUBLIC, chunkIndex = 0, owner = Option(b_pub), data = ByteVector.empty),
      ChunkEntry(chunkType = ChunkType.SIG_P2SH, chunkPrivacy= ChunkPrivacy.PUBLIC, chunkIndex = 1, owner = Option(b_pub), data = ByteVector.empty),
      ChunkEntry(chunkType = ChunkType.SIG_P2SH, chunkPrivacy= ChunkPrivacy.PUBLIC, chunkIndex = 2, owner = Option(a_pub), data = ByteVector.empty)
    )
    val t10_a = Seq(
      ChunkEntry(chunkType = ChunkType.SECRET_IN, chunkPrivacy= ChunkPrivacy.PUBLIC, chunkIndex = 0, owner = Option(a_pub), data = a_secret),
      ChunkEntry(chunkType = ChunkType.SECRET_IN, chunkPrivacy= ChunkPrivacy.PUBLIC, chunkIndex = 0, owner = Option(b_pub), data = ByteVector.empty),
      ChunkEntry(chunkType = ChunkType.SIG_P2SH, chunkPrivacy= ChunkPrivacy.PUBLIC, chunkIndex = 1, owner = Option(b_pub), data = ByteVector.empty),
      ChunkEntry(chunkType = ChunkType.SIG_P2SH, chunkPrivacy= ChunkPrivacy.PUBLIC, chunkIndex = 2, owner = Option(a_pub), data = ByteVector.empty)
    )
    val t5_entry_a = TxEntry(name = "T5", indexData = Map(0 -> IndexEntry(amt = Satoshi(513333) ,chunkData = t5_a)))
    val t8_entry_a = TxEntry(name = "T8", indexData = Map(0 -> IndexEntry(amt = Satoshi(513333) ,chunkData = t8_a)))
    val t10_entry_a = TxEntry(name = "T10", indexData = Map(0 -> IndexEntry(amt = Satoshi(513333) ,chunkData = t10_a)))
    // Revert content of t2 and save content of new t5-8-10
    metadb.save(t2_entry)
    metadb.save(t5_entry_a)
    metadb.save(t8_entry_a)
    metadb.save(t10_entry_a)

    val a_view = stateSerializer.prettyPrintState(State(partdb, txdb, metadb))

    val alice = testSystem.actorOf(Props(classOf[Client]))
    val bob = testSystem.actorOf(Props(classOf[Client]))

    // Initialize and convert actor state
    alice ! Init(jsonState = a_view, identity = a_priv)
    bob ! Init(jsonState = b_view, identity = b_priv)
    Thread.sleep(1000)

    // Start network node.
    alice ! Listen("test_application.conf", alice_p.endpoint.system)
    bob ! Listen("test_application_b.conf", bob_p.endpoint.system)
    Thread.sleep(1000)

    alice ! PreInit()
    bob ! PreInit()

    Thread.sleep(2000)

    alice ! PreInit()
    bob ! PreInit()

    Thread.sleep(2000)

    // Replicate the example flow corresponding to the given secrets.
    for (txName <- Seq("Tinit", "T1", "T5", "T6")) {
      println("Assembling %s..." format (txName))
      val future3 = alice ? TryAssemble(txName)
      val res3 = Await.result(future3, 2000 millis).asInstanceOf[AssembledTx].serializedTx
      // The node has produced a transaction.
      assert(res3.length != 0)
      println(Transaction.read(res3).txIn)
    }

    for (txName <- Seq("T2", "T3", "T8", "T9")) {
      val future3 = bob ? TryAssemble(txName)
      val res3 = Await.result(future3, 2000 millis).asInstanceOf[AssembledTx].serializedTx
      // The node has produced a transaction.
      assert(res3.length != 0)
      println(Transaction.read(res3).txIn)
    }

    Thread.sleep(1000)

    alice ! StopListening()
    bob ! StopListening()
    Thread.sleep(1000)

  }

  test("Timed commitment") {
    /*
    #lang bitml

(participant "A" "03ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c3")
(participant "B" "03859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e")

(define (txA) "tx:0200000001c75e1b501f7a1691b16d06398b4235ab35e11ccda3c3f9160d68739c84d435ed00000000e4483045022100ad5f0022e6ae8e789a97ca9497b8d307690b96ddbfcdf822711b1983b328d26702204f276374584292322c1ad33dc7b67600673ace464e9c60990de7a0123933803c014730440220055c42ae93321b4061055c782be11d3392c84ff34b1d4fbbe3a9e208f63518170220231d7712a4d36e5397264bfc8db89fd1d13d64937ee886fb9872f260bf979760014c516b6b006c766c766b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352aeffffffff01d5ea0600000000001976a914ded135b86a7ff97aece531c8b97dc8a3cb3ddc7488ac00000000@0")
(define (txFee) "tx:02000000013ea7dd4d036b9a3048992e9c7e4b8c054e7949d08d233005aa79c50ee92ff0a800000000e3483045022100f956e4b07562a209662b42ab0b6d26784de59470d992a542c207e74bf03776d5022071a5089744aa25316d29cb9d1e9bd28f5f50eba6c2c5b57177bf0a17c35308a601463043021f26ce5a6c343fcb5edf3a06dbb95006cbf063393ec7b5beebd16e2c8120c059022015c4afec46a1c04d1dcfbf8e414d9f83d0a008c91b1a96f6b499edec2b8d1d48014c516b6b006c766c766b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352aeffffffff01d5ea0600000000001976a914ded135b86a7ff97aece531c8b97dc8a3cb3ddc7488ac00000000@0")

(debug-mode)

(contract
 (pre (deposit "A" 0.00453333 (ref (txA)))
      (fee "A" 0.00453333 (ref (txFee)))
      (secret "A" a "b472a266d0bd89c13706a4132ccfb16f7c3b9fcb"))

 (choice (reveal (a) (withdraw "A"))
      (after 1550000 (withdraw "B")))

 (check-liquid))

 const privA = _ removed

const sec_a:string = "000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001"

const pubkeyA6 = pubkey:03ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c3
const pubkeyB1 = pubkey:03859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e
const pubkeyB3 = pubkey:03859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e
const pubkeyB5 = pubkey:03859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e
const pubkeyA2 = pubkey:03ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c3
const pubkeyA4 = pubkey:03ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c3

const pubkeyB = pubkey:03859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e
const pubkeyA = pubkey:03ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c3

transaction Tinit {
 input = [ tx:0200000001c75e1b501f7a1691b16d06398b4235ab35e11ccda3c3f9160d68739c84d435ed00000000e4483045022100ad5f0022e6ae8e789a97ca9497b8d307690b96ddbfcdf822711b1983b328d26702204f276374584292322c1ad33dc7b67600673ace464e9c60990de7a0123933803c014730440220055c42ae93321b4061055c782be11d3392c84ff34b1d4fbbe3a9e208f63518170220231d7712a4d36e5397264bfc8db89fd1d13d64937ee886fb9872f260bf979760014c516b6b006c766c766b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352aeffffffff01d5ea0600000000001976a914ded135b86a7ff97aece531c8b97dc8a3cb3ddc7488ac00000000@0:sig(privA);
 tx:02000000013ea7dd4d036b9a3048992e9c7e4b8c054e7949d08d233005aa79c50ee92ff0a800000000e3483045022100f956e4b07562a209662b42ab0b6d26784de59470d992a542c207e74bf03776d5022071a5089744aa25316d29cb9d1e9bd28f5f50eba6c2c5b57177bf0a17c35308a601463043021f26ce5a6c343fcb5edf3a06dbb95006cbf063393ec7b5beebd16e2c8120c059022015c4afec46a1c04d1dcfbf8e414d9f83d0a008c91b1a96f6b499edec2b8d1d48014c516b6b006c766c766b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352aeffffffff01d5ea0600000000001976a914ded135b86a7ff97aece531c8b97dc8a3cb3ddc7488ac00000000@0:sig(privA) ]
 output = 0.00876666 BTC : fun(a:string, sB, sA) . (( (hash160(a) == hash:9f3df038eeadc0c240fb7f82e31fdfe46804fc7c && size(a) >= 128 && versig(pubkeyB1, pubkeyA2; sB, sA)) ||
 versig(pubkeyB3, pubkeyA4; sB, sA) ))
}

const sigBT1 : signature = _
//received from Bob

transaction T1 {
 input = [ Tinit@0:sec_a sigBT1 sig(privA) ]
 output = 0.00846666 BTC : fun(sB, sA) . versig(pubkeyB5, pubkeyA6; sB, sA)
}

const sigBT2 : signature = _
//received from Bob

transaction T2 {
 input = [ T1@0:  sigBT2 sig(privA) ]
 output = 0.00816666 BTC : fun(x) . versig(pubkeyA; x)

}

const sigBT3 : signature = _
//received from Bob
const sigAT3 : signature = _

transaction T3 {
 input = [ Tinit@0: "0" sigBT3 sig(privA) ]
 output = 0.00846666 BTC : fun(x) . versig(pubkeyB; x)
 absLock = block 1550000
}

// Switched pubkeys:
// A_PUB: 03ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c3
// B_PUB: 03859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e

eval Tinit, T1, T2, T3

    Build state

    Edited public state

    const sec_a:string = _

const pubkeyA6 = pubkey:03ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c3
const pubkeyB1 = pubkey:03859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e
const pubkeyB3 = pubkey:03859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e
const pubkeyB5 = pubkey:03859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e
const pubkeyA2 = pubkey:03ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c3
const pubkeyA4 = pubkey:03ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c3

const pubkeyB = pubkey:03859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e
const pubkeyA = pubkey:03ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c3

const sigA0 : signature = _
//received from Alice

const sigAFee : signature = _
//received from Alice

transaction Tinit {
 input = [ tx:0200000001c75e1b501f7a1691b16d06398b4235ab35e11ccda3c3f9160d68739c84d435ed00000000e4483045022100ad5f0022e6ae8e789a97ca9497b8d307690b96ddbfcdf822711b1983b328d26702204f276374584292322c1ad33dc7b67600673ace464e9c60990de7a0123933803c014730440220055c42ae93321b4061055c782be11d3392c84ff34b1d4fbbe3a9e208f63518170220231d7712a4d36e5397264bfc8db89fd1d13d64937ee886fb9872f260bf979760014c516b6b006c766c766b7c6b5221034a7192e922118173906555a39f28fa1e0b65657fc7f403094da4f85701a5f809210339bd7fade9167e09681d68c5fc80b72166fe55bbb84211fd12bde1d57247fbe152aeffffffff01d5ea0600000000001976a914ded135b86a7ff97aece531c8b97dc8a3cb3ddc7488ac00000000@0:sigA0;
 tx:02000000013ea7dd4d036b9a3048992e9c7e4b8c054e7949d08d233005aa79c50ee92ff0a800000000e3483045022100f956e4b07562a209662b42ab0b6d26784de59470d992a542c207e74bf03776d5022071a5089744aa25316d29cb9d1e9bd28f5f50eba6c2c5b57177bf0a17c35308a601463043021f26ce5a6c343fcb5edf3a06dbb95006cbf063393ec7b5beebd16e2c8120c059022015c4afec46a1c04d1dcfbf8e414d9f83d0a008c91b1a96f6b499edec2b8d1d48014c516b6b006c766c766b7c6b5221034a7192e922118173906555a39f28fa1e0b65657fc7f403094da4f85701a5f809210339bd7fade9167e09681d68c5fc80b72166fe55bbb84211fd12bde1d57247fbe152aeffffffff01d5ea0600000000001976a914ded135b86a7ff97aece531c8b97dc8a3cb3ddc7488ac00000000@0:sigAFee ]
 output = 0.00876666 BTC : fun(a:string, sB, sA) . (( (hash160(a) == hash:9f3df038eeadc0c240fb7f82e31fdfe46804fc7c && size(a) >= 128 && versig(pubkeyB1, pubkeyA2; sB, sA)) ||
 versig(pubkeyB3, pubkeyA4; sB, sA) ))
}

const sigAT1 : signature = _
const sigBT1 : signature = _
//received from Bob

transaction T1 {
 input = [ Tinit@0:sec_a sigBT1 sigAT1 ]
 output = 0.00846666 BTC : fun(sB, sA) . versig(pubkeyB5, pubkeyA6; sB, sA)
}

const sigAT2 : signature = _
const sigBT2 : signature = _
//received from Bob

transaction T2 {
 input = [ T1@0:  sigBT2 sigAT2 ]
 output = 0.00816666 BTC : fun(x) . versig(pubkeyA; x)

}

const sigBT3 : signature = _
//received from Bob
const sigAT3 : signature = _

transaction T3 {
 input = [ Tinit@0: "0" sigBT3 sigAT3 ]
 output = 0.00846666 BTC : fun(x) . versig(pubkeyB; x)
 absLock = block 1550000
}

// A_PUB: 03ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c3
// B_PUB: 03859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e

eval Tinit, T1, T2, T3

  eval results:

Tinit
Transaction{939783b5de6357c52de66658d75b3f939d6e1e4f3aafc357c6f2059e34b8d00f
weight: 776 wu, 194 bytes
version 2
purpose: UNKNOWN
   in   0[] PUSHDATA(33)[02a6d35321c8930c1da17df79edebaf13192ee3e39c9abcea6d8dd9c5f3640e2ab]
        P2PKH addr:n1q6vo5VabL1BpqVKyHjvh4vaHrAq5NcYR  outpoint:f7097c3523aecc62dc97c790f1b276db9fc662f7a4b13fd548093ff11a09d33d:0
   in   0[] PUSHDATA(33)[02a6d35321c8930c1da17df79edebaf13192ee3e39c9abcea6d8dd9c5f3640e2ab]
        P2PKH addr:n1q6vo5VabL1BpqVKyHjvh4vaHrAq5NcYR  outpoint:08f24c84628641fecf0f33f013dbdc24c507530282cfb3c5eff97c6c2d502e59:0
   out  HASH160 PUSHDATA(20)[e2fc356d35e4759c282c9c49a39a3e8fd6f756d8] EQUAL  0.00876666 BTC
        P2SH addr:2NDwQqQTByo5XZp2dgtXzCA5eQWRDqamZaQ
}
02000000023dd3091af13f0948d53fb1a4f762c69fdb76b2f190c797dc62ccae23357c09f70000000023002102a6d35321c8930c1da17df79edebaf13192ee3e39c9abcea6d8dd9c5f3640e2abffffffff592e502d6c7cf9efc5b3cf82025307c524dcdb13f0330fcffe418662844cf2080000000023002102a6d35321c8930c1da17df79edebaf13192ee3e39c9abcea6d8dd9c5f3640e2abffffffff017a600d000000000017a914e2fc356d35e4759c282c9c49a39a3e8fd6f756d88700000000


T1
Transaction{43dc1a8327bb2585b69ccc9806c5cb32da30c77311d732f789c8218f191d62d0
weight: 1228 wu, 307 bytes
version 2
purpose: UNKNOWN
   in   0[] 0[] 0[] PUSHDATA1[6b6b766ba9149f3df038eeadc0c240fb7f82e31fdfe46804fc7c87636c766b827c75028000a267006863006c6c766b7c6c6c766b7c6b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352ae670068635167006c6c766b7c6c6c766b7c6b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352ae68]
        P2SH addr:2NDwQqQTByo5XZp2dgtXzCA5eQWRDqamZaQ  outpoint:939783b5de6357c52de66658d75b3f939d6e1e4f3aafc357c6f2059e34b8d00f:0
   out  HASH160 PUSHDATA(20)[2e38f05e636989a28f71fe9be443f82e9ce3453e] EQUAL  0.00846666 BTC
        P2SH addr:2MwTdHJ4thrcqJLUuhKCnUoajqKCiuFsEyU
}
02000000010fd0b8349e05f2c657c3af3a4f1e6e9d933f5bd75866e62dc55763deb583979300000000e00000004cdb6b6b766ba9149f3df038eeadc0c240fb7f82e31fdfe46804fc7c87636c766b827c75028000a267006863006c6c766b7c6c6c766b7c6b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352ae670068635167006c6c766b7c6c6c766b7c6b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352ae68ffffffff014aeb0c000000000017a9142e38f05e636989a28f71fe9be443f82e9ce3453e8700000000


T2
Transaction{72e376fa9e8f852ff43c806bccfb3abfe67cc1c4c36c5192c8d09d016f7f6513
weight: 680 wu, 170 bytes
version 2
purpose: UNKNOWN
   in   0[] 0[] PUSHDATA1[6b6b006c766c766b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352ae]
        P2SH addr:2MwTdHJ4thrcqJLUuhKCnUoajqKCiuFsEyU  outpoint:43dc1a8327bb2585b69ccc9806c5cb32da30c77311d732f789c8218f191d62d0:0
   out  DUP HASH160 PUSHDATA(20)[448f9bd84d520fb00adb83f26d8a78ddc5403c89] EQUALVERIFY CHECKSIG  0.00816666 BTC
        P2PKH addr:mmmUHDB4rQasyk5FszofhjfEW9vHuZM5Lz
}
0200000001d0621d198f21c889f732d71173c730da32cbc50698cc9cb68525bb27831adc43000000005500004c516b6b006c766c766b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352aeffffffff011a760c00000000001976a914448f9bd84d520fb00adb83f26d8a78ddc5403c8988ac00000000


T3
Transaction{d480203d072f885c8cee3414288baaab98f544b2fd2061f5ba1549b4a048f661
weight: 1240 wu, 310 bytes
version 2
time locked until block 1550000
purpose: UNKNOWN
   in   PUSHDATA(1)[30] 0[] 0[] PUSHDATA1[6b6b766ba9149f3df038eeadc0c240fb7f82e31fdfe46804fc7c87636c766b827c75028000a267006863006c6c766b7c6c6c766b7c6b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352ae670068635167006c6c766b7c6c6c766b7c6b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352ae68]
        P2SH addr:2NDwQqQTByo5XZp2dgtXzCA5eQWRDqamZaQ  outpoint:939783b5de6357c52de66658d75b3f939d6e1e4f3aafc357c6f2059e34b8d00f:0
        sequence:fffffffe
   out  DUP HASH160 PUSHDATA(20)[ba91ed34ad92a7c2aa2d764c73cd0f31a18df680] EQUALVERIFY CHECKSIG  0.00846666 BTC
        P2PKH addr:mxXSnteng7Jkg3sc7xps6Nnw8jxEgLEBky
}
02000000010fd0b8349e05f2c657c3af3a4f1e6e9d933f5bd75866e62dc55763deb583979300000000e1013000004cdb6b6b766ba9149f3df038eeadc0c240fb7f82e31fdfe46804fc7c87636c766b827c75028000a267006863006c6c766b7c6c6c766b7c6b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352ae670068635167006c6c766b7c6c6c766b7c6b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352ae68feffffff014aeb0c00000000001976a914ba91ed34ad92a7c2aa2d764c73cd0f31a18df68088acb0a61700


     */
    implicit val timeout : Timeout = 1 second


    val a_priv = PrivateKey.fromBase58("cSthBXr8YQAexpKeh22LB9PdextVE1UJeahmyns5LzcmMDSy59L4", Base58.Prefix.SecretKeyTestnet)._1
    val a_pub = a_priv.publicKey
    println(a_pub)
    val alice_p = Participant("Alice", List(a_pub), Address("akka", "test", "127.0.0.1", 25000))
    val b_priv = PrivateKey.fromBase58("cQmSz3Tj3usor9byskhpCTfrmCM5cLetLU9Xw6y2csYhxSbKDzUn", Base58.Prefix.SecretKeyTestnet)._1
    val b_pub = b_priv.publicKey
    println(b_pub)
    val bob_p = Participant("Bob", List(b_pub), Address("akka", "test", "127.0.0.1", 25001))

    val partdb = new ParticipantStorage()
    partdb.save(alice_p)
    partdb.save(bob_p)

    val tinit_raw = Transaction.read("02000000023dd3091af13f0948d53fb1a4f762c69fdb76b2f190c797dc62ccae23357c09f70000000023002102a6d35321c8930c1da17df79edebaf13192ee3e39c9abcea6d8dd9c5f3640e2abffffffff592e502d6c7cf9efc5b3cf82025307c524dcdb13f0330fcffe418662844cf2080000000023002102a6d35321c8930c1da17df79edebaf13192ee3e39c9abcea6d8dd9c5f3640e2abffffffff017a600d000000000017a914e2fc356d35e4759c282c9c49a39a3e8fd6f756d88700000000")
    val t1_raw = Transaction.read("02000000010fd0b8349e05f2c657c3af3a4f1e6e9d933f5bd75866e62dc55763deb583979300000000e00000004cdb6b6b766ba9149f3df038eeadc0c240fb7f82e31fdfe46804fc7c87636c766b827c75028000a267006863006c6c766b7c6c6c766b7c6b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352ae670068635167006c6c766b7c6c6c766b7c6b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352ae68ffffffff014aeb0c000000000017a9142e38f05e636989a28f71fe9be443f82e9ce3453e8700000000")
    val t2_raw = Transaction.read("0200000001d0621d198f21c889f732d71173c730da32cbc50698cc9cb68525bb27831adc43000000005500004c516b6b006c766c766b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352aeffffffff011a760c00000000001976a914448f9bd84d520fb00adb83f26d8a78ddc5403c8988ac00000000")
    val t3_raw = Transaction.read("02000000010fd0b8349e05f2c657c3af3a4f1e6e9d933f5bd75866e62dc55763deb583979300000000e1013000004cdb6b6b766ba9149f3df038eeadc0c240fb7f82e31fdfe46804fc7c87636c766b827c75028000a267006863006c6c766b7c6c6c766b7c6b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352ae670068635167006c6c766b7c6c6c766b7c6b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352ae68feffffff014aeb0c00000000001976a914ba91ed34ad92a7c2aa2d764c73cd0f31a18df68088acb0a61700")

    val txdb = new TxStorage()
    txdb.save("Tinit", tinit_raw)
    txdb.save("T1", t1_raw)
    txdb.save("T2", t2_raw)
    txdb.save("T3", t3_raw)

    val tinit0_chunks = Seq(
      ChunkEntry(chunkType = ChunkType.SIG_P2PKH, chunkPrivacy= ChunkPrivacy.AUTH, chunkIndex = 0, owner = Option(a_pub), data = ByteVector.empty))
    val tinit1_chunks = Seq(
      ChunkEntry(chunkType = ChunkType.SIG_P2PKH, chunkPrivacy= ChunkPrivacy.AUTH, chunkIndex = 0, owner = Option(a_pub), data = ByteVector.empty))
    val t1_chunks = Seq(
      ChunkEntry(chunkType = ChunkType.SECRET_IN, chunkPrivacy= ChunkPrivacy.PRIVATE, chunkIndex = 0, owner = Option(a_pub), data = ByteVector.empty),
      ChunkEntry(chunkType = ChunkType.SIG_P2SH, chunkPrivacy= ChunkPrivacy.PUBLIC, chunkIndex = 1, owner = Option(b_pub), data = ByteVector.empty),
      ChunkEntry(chunkType = ChunkType.SIG_P2SH, chunkPrivacy= ChunkPrivacy.PUBLIC, chunkIndex = 2, owner = Option(a_pub), data = ByteVector.empty))
    val t2_chunks = Seq(
      ChunkEntry(chunkType = ChunkType.SIG_P2SH, chunkPrivacy= ChunkPrivacy.PUBLIC, chunkIndex = 0, owner = Option(b_pub), data = ByteVector.empty),
      ChunkEntry(chunkType = ChunkType.SIG_P2SH, chunkPrivacy= ChunkPrivacy.PUBLIC, chunkIndex = 1, owner = Option(a_pub), data = ByteVector.empty))
    val t3_chunks = Seq(
      ChunkEntry(chunkType = ChunkType.SIG_P2SH, chunkPrivacy= ChunkPrivacy.PUBLIC, chunkIndex = 1, owner = Option(b_pub), data = ByteVector.empty),
      ChunkEntry(chunkType = ChunkType.SIG_P2SH, chunkPrivacy= ChunkPrivacy.PUBLIC, chunkIndex = 2, owner = Option(a_pub), data = ByteVector.empty))

    val tinit_entry = TxEntry(name = "Tinit", indexData = Map(
      0 -> IndexEntry(amt = Satoshi(453333) ,chunkData = tinit0_chunks),
      1 -> IndexEntry(amt = Satoshi(453333) ,chunkData = tinit1_chunks)))
    val t1_entry = TxEntry(name = "T1", indexData = Map(0 -> IndexEntry(amt = Satoshi(876666) ,chunkData = t1_chunks)))
    val t2_entry = TxEntry(name = "T2", indexData = Map(0 -> IndexEntry(amt = Satoshi(846666) ,chunkData = t2_chunks)))
    val t3_entry = TxEntry(name = "T3", indexData = Map(0 -> IndexEntry(amt = Satoshi(876666) ,chunkData = t3_chunks)))

    val metadb = new MetaStorage()
    metadb.save(tinit_entry)
    metadb.save(t1_entry)
    metadb.save(t2_entry)
    metadb.save(t3_entry)

    val blankState = new Serializer(ChunkPrivacy.PRIVATE).prettyPrintState(State(partdb, txdb, metadb))

    // Edit chunk with secret information for test convenience. In a real use case this would either be interactive or baked into the state JSON

    val t1_chunks_secret = Seq(
      ChunkEntry(chunkType = ChunkType.SECRET_IN, chunkPrivacy= ChunkPrivacy.PRIVATE, chunkIndex = 0, owner = Option(a_pub), data = ByteVector.fromValidHex("303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303031")),
      ChunkEntry(chunkType = ChunkType.SIG_P2SH, chunkPrivacy= ChunkPrivacy.PUBLIC, chunkIndex = 1, owner = Option(b_pub), data = ByteVector.empty),
      ChunkEntry(chunkType = ChunkType.SIG_P2SH, chunkPrivacy= ChunkPrivacy.PUBLIC, chunkIndex = 2, owner = Option(a_pub), data = ByteVector.empty))
    val t1_entry_secret = TxEntry(name = "T1", indexData = Map(0 -> IndexEntry(amt = Satoshi(876666) ,chunkData = t1_chunks_secret)))
    metadb.save(t1_entry_secret)

    // If we don't specify the higher visibility access, the secret is stripped anyway.
    val state_alice_view = new Serializer(ChunkPrivacy.PRIVATE).prettyPrintState(State(partdb, txdb, metadb))

    val alice = testSystem.actorOf(Props(classOf[Client]))
    val bob = testSystem.actorOf(Props(classOf[Client]))

    // Initialize and convert actor state
    alice ! Init(jsonState = state_alice_view, identity = a_priv)
    bob ! Init(jsonState = blankState, identity = b_priv)

    // Start network node.
    alice ! Listen("test_application.conf", alice_p.endpoint.system)
    bob ! Listen("test_application_b.conf", bob_p.endpoint.system)

    // If Bob tries to assemble Tinit now, he'll be missing the authorization from Alice. This will be reflected in the logging.
    bob ! TryAssemble("Tinit")

    // Ensure we have all public chunks before we authorize Tinit.
    // The first time this is called, it will fail and then try fetching every missing chunk.
    alice ! PreInit()
    // If he wants, Bob can also use this to receive all public chunks, even if he doesn't have to authorize any chunk.
    // However, until Alice authorizes Tinit, he won't receive the signatures to sigA0 and sigAFee and can't publish Tinit on his own.
    bob ! PreInit()

    Thread.sleep(2000)
    // If alice doesn't have any empty public chunks anymore, it should be safe to share the signatures sigA0 and sigAFee.
    alice ! PreInit()

    // Now Alice should be able to assemble Tinit, T1 and T2.
    alice ! TryAssemble("Tinit")


    /*
    // TODO: Fix several errors in the logic itself.
    // After inserting the signatures, the Tinit hash changes.
    // Therefore Bob is unable to compute signatures for T1, T2 and T3 before receiving the Tinit signatures from A.
    // However, once Alice has shared her Tinit signatures, Bob can simply refuse to share his signatures
    // and effectively ensures that the only way for the contract to progress is for him to cash out after the timelock.
    // We do not have control over the txFee or the tx0, so we can't convert the Tinit input into witness transactions.
    alice ! TryAssemble("T1")
    alice ! TryAssemble("T2")


    // In the same way, Bob will now be able to fetch Alice's signatures for Tinit and assemble it.
    // He will not be able to assemble T1, since that chunk is marked as PRIVATE and can't be shared at all.
    // He should be able to assemble T3.
    bob ! TryAssemble("Tinit") // Still missing the signatures at the time this is called, but it will make the query inside.
    bob ! TryAssemble("T3") // Can be assembled with just the public chunks, but is still subject to the timelock for publication.




    // Print the current state for every participant. AUTH and PRIVATE chunks won't be reflected here.
    for (participant <- Seq(alice, bob)) {
      println(participant.path)
      val futState = participant ? DumpState()
      println(Await.result(futState, timeout.duration).asInstanceOf[CurrentState].state)
    }

     */


    alice ! StopListening()
    bob ! StopListening()
  }

  test("Timed committment correction 1: WPKH Tinit inputs") {
    // The test is almost identical to the original timed commitment, but the Client tries to solve the signature exchange sequence issue by:
    // - Converting the Tinit chunks into WPKH (assumes they were such from the start and were tagged as PKH by balzac)
    // - Changed the raw transaction sigScript to match that and fixed every other reference to them. (same as the above)
    // Obviously we can't actually redeem the real txA and txFee with a witness script.


    implicit val timeout : Timeout = 1 second


    val a_priv = PrivateKey.fromBase58("cSthBXr8YQAexpKeh22LB9PdextVE1UJeahmyns5LzcmMDSy59L4", Base58.Prefix.SecretKeyTestnet)._1
    val a_pub = a_priv.publicKey
    println(a_pub)
    val alice_p = Participant("Alice", List(a_pub), Address("akka", "test", "127.0.0.1", 25000))
    val b_priv = PrivateKey.fromBase58("cQmSz3Tj3usor9byskhpCTfrmCM5cLetLU9Xw6y2csYhxSbKDzUn", Base58.Prefix.SecretKeyTestnet)._1
    val b_pub = b_priv.publicKey
    println(b_pub)
    val bob_p = Participant("Bob", List(b_pub), Address("akka", "test", "127.0.0.1", 25001))

    val partdb = new ParticipantStorage()
    partdb.save(alice_p)
    partdb.save(bob_p)

    val tinit_raw = Transaction.read("02000000023dd3091af13f0948d53fb1a4f762c69fdb76b2f190c797dc62ccae23357c09f70000000023002102a6d35321c8930c1da17df79edebaf13192ee3e39c9abcea6d8dd9c5f3640e2abffffffff592e502d6c7cf9efc5b3cf82025307c524dcdb13f0330fcffe418662844cf2080000000023002102a6d35321c8930c1da17df79edebaf13192ee3e39c9abcea6d8dd9c5f3640e2abffffffff017a600d000000000017a914e2fc356d35e4759c282c9c49a39a3e8fd6f756d88700000000")
    // Now unused since the Client will patch the tinit_raw for us.
    val tinit_wit = Transaction.read("020000000001023dd3091af13f0948d53fb1a4f762c69fdb76b2f190c797dc62ccae23357c09f70000000000ffffffff592e502d6c7cf9efc5b3cf82025307c524dcdb13f0330fcffe418662844cf2080000000000ffffffff017a600d000000000017a914e2fc356d35e4759c282c9c49a39a3e8fd6f756d88702002102a6d35321c8930c1da17df79edebaf13192ee3e39c9abcea6d8dd9c5f3640e2ab02002102a6d35321c8930c1da17df79edebaf13192ee3e39c9abcea6d8dd9c5f3640e2ab00000000")
    val t1_raw = Transaction.read("02000000010fd0b8349e05f2c657c3af3a4f1e6e9d933f5bd75866e62dc55763deb583979300000000e00000004cdb6b6b766ba9149f3df038eeadc0c240fb7f82e31fdfe46804fc7c87636c766b827c75028000a267006863006c6c766b7c6c6c766b7c6b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352ae670068635167006c6c766b7c6c6c766b7c6b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352ae68ffffffff014aeb0c000000000017a9142e38f05e636989a28f71fe9be443f82e9ce3453e8700000000")
    val t2_raw = Transaction.read("0200000001d0621d198f21c889f732d71173c730da32cbc50698cc9cb68525bb27831adc43000000005500004c516b6b006c766c766b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352aeffffffff011a760c00000000001976a914448f9bd84d520fb00adb83f26d8a78ddc5403c8988ac00000000")
    val t3_raw = Transaction.read("02000000010fd0b8349e05f2c657c3af3a4f1e6e9d933f5bd75866e62dc55763deb583979300000000e1013000004cdb6b6b766ba9149f3df038eeadc0c240fb7f82e31fdfe46804fc7c87636c766b827c75028000a267006863006c6c766b7c6c6c766b7c6b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352ae670068635167006c6c766b7c6c6c766b7c6b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e2103ff41f23b70b1c83b01914eb223d7a97a6c2b24e9a9ef2762bf25ed1c1b83c9c352ae68feffffff014aeb0c00000000001976a914ba91ed34ad92a7c2aa2d764c73cd0f31a18df68088acb0a61700")

    /*
    // Propagate txid changes manually.
    val t1_wit = t1_raw.copy(txIn = t1_raw.txIn.map(
      x => x.copy(outPoint = x.outPoint.hash match {
        case tinit_raw.hash => x.outPoint.copy(hash = tinit_wit.hash)
        case _ => x.outPoint
      })))
    val t3_wit = t3_raw.copy(txIn = t3_raw.txIn.map(
      x => x.copy(outPoint = x.outPoint.hash match {
        case tinit_raw.hash => x.outPoint.copy(hash = tinit_wit.hash)
        case _ => x.outPoint
      })))
    val t2_wit = t2_raw.copy(txIn = t2_raw.txIn.map(
      x => x.copy(outPoint = x.outPoint.hash match {
        case t1_raw.hash => x.outPoint.copy(hash = t1_wit.hash)
        case _ => x.outPoint
      })))

     */


    val txdb = new TxStorage()
    // Define it with the original Tinit referenced by T1 and T3
    txdb.save("Tinit", tinit_raw)
    txdb.save("T1", t1_raw)
    txdb.save("T2", t2_raw)
    txdb.save("T3", t3_raw)
    // Make use of the current propagation mechanism to change Tinit references automatically
    // This should be done automatically inside Client.initState() now.
    // txdb.save("Tinit", tinit_wit)

    // Same for these.
    /*val tinit0w_chunks = Seq(
      ChunkEntry(chunkType = ChunkType.SIG_P2WPKH, chunkPrivacy= ChunkPrivacy.AUTH, chunkIndex = 0, owner = Option(a_pub), data = ByteVector.empty))
    val tinit1w_chunks = Seq(
      ChunkEntry(chunkType = ChunkType.SIG_P2WPKH, chunkPrivacy= ChunkPrivacy.AUTH, chunkIndex = 0, owner = Option(a_pub), data = ByteVector.empty))
      */

    val tinit0_chunks = Seq(
      ChunkEntry(chunkType = ChunkType.SIG_P2PKH, chunkPrivacy= ChunkPrivacy.AUTH, chunkIndex = 0, owner = Option(a_pub), data = ByteVector.empty))
    val tinit1_chunks = Seq(
      ChunkEntry(chunkType = ChunkType.SIG_P2PKH, chunkPrivacy= ChunkPrivacy.AUTH, chunkIndex = 0, owner = Option(a_pub), data = ByteVector.empty))
    val t1_chunks = Seq(
      ChunkEntry(chunkType = ChunkType.SECRET_IN, chunkPrivacy= ChunkPrivacy.PRIVATE, chunkIndex = 0, owner = Option(a_pub), data = ByteVector.empty),
      ChunkEntry(chunkType = ChunkType.SIG_P2SH, chunkPrivacy= ChunkPrivacy.PUBLIC, chunkIndex = 1, owner = Option(b_pub), data = ByteVector.empty),
      ChunkEntry(chunkType = ChunkType.SIG_P2SH, chunkPrivacy= ChunkPrivacy.PUBLIC, chunkIndex = 2, owner = Option(a_pub), data = ByteVector.empty))
    val t2_chunks = Seq(
      ChunkEntry(chunkType = ChunkType.SIG_P2SH, chunkPrivacy= ChunkPrivacy.PUBLIC, chunkIndex = 0, owner = Option(b_pub), data = ByteVector.empty),
      ChunkEntry(chunkType = ChunkType.SIG_P2SH, chunkPrivacy= ChunkPrivacy.PUBLIC, chunkIndex = 1, owner = Option(a_pub), data = ByteVector.empty))
    val t3_chunks = Seq(
      ChunkEntry(chunkType = ChunkType.SIG_P2SH, chunkPrivacy= ChunkPrivacy.PUBLIC, chunkIndex = 1, owner = Option(b_pub), data = ByteVector.empty),
      ChunkEntry(chunkType = ChunkType.SIG_P2SH, chunkPrivacy= ChunkPrivacy.PUBLIC, chunkIndex = 2, owner = Option(a_pub), data = ByteVector.empty))

    val tinit_entry = TxEntry(name = "Tinit", indexData = Map(
      0 -> IndexEntry(amt = Satoshi(453333) ,chunkData = tinit0_chunks),
      1 -> IndexEntry(amt = Satoshi(453333) ,chunkData = tinit1_chunks)))
    val t1_entry = TxEntry(name = "T1", indexData = Map(0 -> IndexEntry(amt = Satoshi(876666) ,chunkData = t1_chunks)))
    val t2_entry = TxEntry(name = "T2", indexData = Map(0 -> IndexEntry(amt = Satoshi(846666) ,chunkData = t2_chunks)))
    val t3_entry = TxEntry(name = "T3", indexData = Map(0 -> IndexEntry(amt = Satoshi(876666) ,chunkData = t3_chunks)))

    val metadb = new MetaStorage()
    metadb.save(tinit_entry)
    metadb.save(t1_entry)
    metadb.save(t2_entry)
    metadb.save(t3_entry)

    val blankState = new Serializer(ChunkPrivacy.PRIVATE).prettyPrintState(State(partdb, txdb, metadb))

    // Edit chunk with secret information for test convenience. In a real use case this would either be interactive or baked into the state JSON

    val t1_chunks_secret = Seq(
      ChunkEntry(chunkType = ChunkType.SECRET_IN, chunkPrivacy= ChunkPrivacy.PRIVATE, chunkIndex = 0, owner = Option(a_pub), data = ByteVector.fromValidHex("303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303031")),
      ChunkEntry(chunkType = ChunkType.SIG_P2SH, chunkPrivacy= ChunkPrivacy.PUBLIC, chunkIndex = 1, owner = Option(b_pub), data = ByteVector.empty),
      ChunkEntry(chunkType = ChunkType.SIG_P2SH, chunkPrivacy= ChunkPrivacy.PUBLIC, chunkIndex = 2, owner = Option(a_pub), data = ByteVector.empty))
    val t1_entry_secret = TxEntry(name = "T1", indexData = Map(0 -> IndexEntry(amt = Satoshi(876666) ,chunkData = t1_chunks_secret)))

    metadb.save(t1_entry_secret)

    // If we don't specify the higher visibility access, the secret is stripped anyway.
    val state_alice_view = new Serializer(ChunkPrivacy.PRIVATE).prettyPrintState(State(partdb, txdb, metadb))

    val alice = testSystem.actorOf(Props(classOf[Client]))
    val bob = testSystem.actorOf(Props(classOf[Client]))

    // Initialize and convert actor state
    alice ! Init(jsonState = state_alice_view, identity = a_priv)
    bob ! Init(jsonState = blankState, identity = b_priv)

    Thread.sleep(2000)

    // Start network node.
    alice ! Listen("test_application.conf", alice_p.endpoint.system)
    bob ! Listen("test_application_b.conf", bob_p.endpoint.system)


    Thread.sleep(2000)
    // Let Alice and Bob exchange public signatures.
    alice ! PreInit()
    bob ! PreInit()

    Thread.sleep(5000) // The VM needs a REALLY long time to do this calculation.
    // If Alice has received every necessary public chunk, she can now also disclose her signatures for the Tinit inputs.
    alice ! PreInit()

    Thread.sleep(1000)

    // Alice should be able to assemble Tinit, T1, T2 (and T3) todo: publishing module
    for (txName <- Seq("Tinit", "T1", "T2", "T3")) {
      val future3 = alice ? TryAssemble(txName)
      val res3 = Await.result(future3, timeout.duration).asInstanceOf[AssembledTx].serializedTx
      // The node has produced a transaction.
      assert(res3.length != 0)
      println(Transaction.read(res3).txIn)
    }

    // Bob should need to retrieve the Tinit chunks that were just authorized to complete Tinit
    bob ! TryAssemble("Tinit")
    Thread.sleep(1500)
    // Bob will not be able to complete T1, no matter what. But he can assemble Tinit and T3 (and T2).
    for (txName <- Seq("Tinit", "T1", "T2", "T3")) {
      val future3 = bob ? TryAssemble(txName)
      // We need a higher timeout here because B will wait 1000ms inside T1 for an answer from A
      val res3 = Await.result(future3, 2000 millis).asInstanceOf[AssembledTx].serializedTx
      // The node has produced a transaction.
      if (txName != "T1") {
        assert(res3.length != 0)
        println(Transaction.read(res3).txIn)
      }else{
        assert(res3.length == 0)
      }
    }

    // Dump and analyze participant state
    for (participant <- Seq(alice, bob)) {
      println(participant.path)
      val futState = participant ? DumpState()
      println(Await.result(futState, timeout.duration).asInstanceOf[CurrentState].state)
    }
    // If the authorization was successful, besides the logging message, A's Tinit chunks should have become "priv":0 instead of 1.


    alice ! StopListening()
    bob ! StopListening()
    Thread.sleep(1000)

  }


    /* This test broke while updating the code to follow BitML spec. It will stay disabled for the moment.
  test("Signature exchange and transaction assembly based on Balzac.Oracle"){
    /**
     * Edited version of Oracle script:
     *
     *
    // tx with Alice's funds, redeemable with Alice's private key
transaction A_funds {
    input = _
    output = 1 BTC: fun(x). versig(Alice.kApub; x)
}

participant Alice {
    // Alice's private key
    private const kA = key:cSthBXr8YQAexpKeh22LB9PdextVE1UJeahmyns5LzcmMDSy59L4
    // Alice's public key
    const kApub = kA.toPubkey

    transaction T(sigA) {
        input = A_funds: sigA
        output = 1 BTC: fun(sigB, sigO). versig(Bob.kBpub, Oracle.kOpub; sigB, sigO)
    }
}

participant Bob {
    // Bob's private key
    private const kB = key:cQmSz3Tj3usor9byskhpCTfrmCM5cLetLU9Xw6y2csYhxSbKDzUn
    // Bob's public key
    const kBpub = kB.toPubkey

    transaction T1(sigB, sigO) {
        input = Alice.T(_): sigB sigO
        output = 1 BTC: fun(x). versig(kB; x)
    }
}

participant Oracle {
    // Oracle's private key
    private const kO = key:cTyxEAoUSKcC9NKFCjxKTaXzP8i1ufEKtwVVtY6AsRPpRgJTZQRt
    // Oracle's public key
    const kOpub = kO.toPubkey

    const sigO = sig(kO) of Bob.T1(_,_)
}


eval Alice.T(_), Bob.T1(_,_)
     *
     * Participants: Alice(priv:cSth...), Bob(priv:cQmS...), Oracle(priv:cTyx...)
     * Transactions: Alice.T, Bob.T1
     * Meta:
     * - T{index 0:{chunk 0:sig_pkh[Alice]}} // Redeem from A_funds, not convertible into witness script.
     * - T1{index 0:{chunk 0:sig_sh[Bob], chunk 1:sig_sh[Oracle]}} // Redeem A.0 script.
     */

    val oracle_t_blank = Transaction.read("02000000017875f000ee77e9adac3224ad43c977b22b02f65339b7c69e1d7780f92e2e7fcb0000000023002102a6d35321c8930c1da17df79edebaf13192ee3e39c9abcea6d8dd9c5f3640e2abffffffff0100e1f5050000000017a91459f8b912203e01527f5feed3dfd6740773c8022d8700000000")
    val oracle_t1_2blank = Transaction.read("0200000001ad765fa02c697d04b393f012c6ea0b9dc471c60ca5832cc9622c591aecabc925000000005500004c516b6b006c766c766b7c6b522103859a0f601cf485a72ec097fddd798c694b0257f69f0229506f8ea923bc600c5e210237c53ebef2992c5b3f0efca8b849f4969095b31e597bdab292385bb132c30f3e52aeffffffff0100e1f505000000001976a914ba91ed34ad92a7c2aa2d764c73cd0f31a18df68088ac00000000")
    val txdb = new TxStorage()
    txdb.save("T", oracle_t_blank)
    txdb.save("T1", oracle_t1_2blank)

    val a_priv = PrivateKey.fromBase58("cSthBXr8YQAexpKeh22LB9PdextVE1UJeahmyns5LzcmMDSy59L4", Base58.Prefix.SecretKeyTestnet)._1
    val a_pub = a_priv.publicKey
    val alice_p = Participant("Alice", List(a_pub), Address("akka", "test", "127.0.0.1", 25000))
    val b_priv = PrivateKey.fromBase58("cQmSz3Tj3usor9byskhpCTfrmCM5cLetLU9Xw6y2csYhxSbKDzUn", Base58.Prefix.SecretKeyTestnet)._1
    val b_pub = b_priv.publicKey
    val bob_p = Participant("Bob", List(b_pub), Address("akka", "test", "127.0.0.1", 25001))
    val o_priv = PrivateKey.fromBase58("cTyxEAoUSKcC9NKFCjxKTaXzP8i1ufEKtwVVtY6AsRPpRgJTZQRt", Base58.Prefix.SecretKeyTestnet)._1
    val o_pub = o_priv.publicKey
    val oracle_p = Participant("Oracle", List(o_pub), Address("akka", "test", "127.0.0.1", 25002))
    val partdb = new ParticipantStorage()
    partdb.save(alice_p)
    partdb.save(bob_p)
    partdb.save(oracle_p)

    val t_chunks = Seq(
      ChunkEntry(chunkType = ChunkType.SIG_P2PKH, chunkPrivacy= ChunkPrivacy.PUBLIC, chunkIndex = 0, owner = Option(a_pub), data = ByteVector.empty))
    val t1_chunks = Seq(
      ChunkEntry(chunkType = ChunkType.SIG_P2SH, chunkPrivacy= ChunkPrivacy.PUBLIC, chunkIndex = 0, owner = Option(b_pub), data = ByteVector.empty),
      ChunkEntry(chunkType = ChunkType.SIG_P2SH, chunkPrivacy= ChunkPrivacy.PUBLIC, chunkIndex = 1, owner = Option(o_pub), data = ByteVector.empty))
    val t_entry = TxEntry(name = "T", indexData = Map(0 -> IndexEntry(amt = Btc(1).toSatoshi ,chunkData = t_chunks)))
    val t1_entry = TxEntry(name = "T1", indexData = Map(0 -> IndexEntry(amt = Btc(1).toSatoshi ,chunkData = t1_chunks)))

    val metadb = new MetaStorage()
    metadb.save(t_entry)
    metadb.save(t1_entry)

    val ser = new Serializer()
    val startingState = ser.prettyPrintState(State(partdb, txdb, metadb))
    // println(startingState)

    // Start 3 Client objects each with their participant's private key and the initial state json.

    val testSystem = ActorSystem(name = "internalTestSystem")


    val alice = testSystem.actorOf(Props(classOf[Client],  a_priv))
    val bob = testSystem.actorOf(Props(classOf[Client],  b_priv))
    val oracle = testSystem.actorOf(Props(classOf[Client],  o_priv))

    // Initializing the state will automatically convert the internal transactions into segwit.
    alice ! Init(startingState)
    bob ! Init(startingState)
    oracle ! Init(startingState)

    // Start their network interfaces.
    alice ! Listen("test_application.conf", alice_p.endpoint.system)
    bob ! Listen("test_application_b.conf", bob_p.endpoint.system)
    oracle ! Listen("test_application_o.conf", oracle_p.endpoint.system)

    // Verify T's TxOut 0 and the matching TxIn has independently been "modernized" into a p2wsh by each participant.
    implicit val timeout : Timeout = Timeout(2000 milliseconds)
    val future = alice ? DumpState()
    val res = ser.loadState(Await.result((future), timeout.duration).asInstanceOf[CurrentState].state)
    // These have been correctly converted. Test_converter tests more on this separately.
    assert(res.metadb.fetch("T1").get.indexData(0).chunkData(0).chunkType == ChunkType.SIG_P2WSH)
    assert(res.metadb.fetch("T1").get.indexData(0).chunkData(1).chunkType == ChunkType.SIG_P2WSH)
    assert(res.txdb.fetch("T").get.txOut(0).publicKeyScript.length == 34) // P2WSH: OP_0 :: PUSHDATA(32 byte sha256)
    // This should be left as is as we can't change the pubKeyScript associated.
    assert(res.metadb.fetch("T").get.indexData(0).chunkData(0).chunkType == ChunkType.SIG_P2PKH)

    // Verify Alice can already assemble T on her own.
    // This creates a problem of its own: if the assembled tx is non-segwit,
    // the Signer can't update the txid referred by everyone else.
    // Alice will receive a warning and then update the references to T.
    //
    val future2 = alice ? TryAssemble("T")
    val res2 = Await.result(future2, timeout.duration).asInstanceOf[AssembledTx].serializedTx
    // The node has produced a transaction.
    assert(res2.length != 0)
    // The signature has been produced and placed.
    assert(Script.parse(Transaction.read(res2).txIn(0).signatureScript)(0) != Seq(OP_0)(0))

    // Alice has already started asking for signatures from the first TryAssemble.
    // alice ! AskForSigs("T1")

    // Let Bob and Oracle exchange signatures to each other when prompted.
    bob ! AskForSigs("T1")
    oracle ! AskForSigs("T1")
    Thread.sleep(3000) // this is completely non-deterministic. TODO: event driven state reporting? totally doable with akka.

    // Verify all 3 have all necessary info to assemble T1.
    for (participant <- Seq(alice, bob, oracle)){
      val future3 = participant ? TryAssemble("T1")
      val res3 = Await.result(future3, timeout.duration).asInstanceOf[AssembledTx].serializedTx
      // The node has produced a transaction.
      assert(res3.length != 0)
      // The signature has been produced and placed.
      assert(Transaction.read(res3).txIn(0).witness.stack(0) != ByteVector.empty)
      assert(Transaction.read(res3).txIn(0).witness.stack(1) != ByteVector.empty)
    }
    // debug: dump final state of each participant into json
    for (participant <- Seq(alice, bob, oracle)) {
      println(participant.path)
      val futState = participant ? DumpState()
      println(Await.result(futState, timeout.duration).asInstanceOf[CurrentState].state)

      participant ! StopListening()
    }
    CoordinatedShutdown(testSystem).run(CoordinatedShutdown.unknownReason)
    Thread.sleep(500)
  }
  */
}
